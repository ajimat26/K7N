<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Game Box Uang Duty</title>
<style>
  body { font-family: Arial, sans-serif; background: #f0f0f0; margin: 20px; }
  #container { max-width: 400px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px #ccc; }
  h2 { text-align: center; color: #333; }
  #money-indicator, #key-indicator, #top-tier, #box-result { margin: 15px 0; font-size: 18px; }
  #open-box-btn { width: 100%; padding: 10px; font-size: 16px; background: #28a745; border: none; color: white; border-radius: 5px; cursor: pointer; }
  #open-box-btn:disabled { background: #aaa; cursor: not-allowed; }
  #top-tier ul { list-style: none; padding-left: 0; }
  #top-tier li { background: #eee; margin: 5px 0; padding: 8px; border-radius: 4px; }
</style>
</head>
<body>

<div id="container">
  <h2>Game Box Uang Duty</h2>

  <div id="money-indicator">Total Uang Tersedia: Rp <span id="total-money">50,000,000</span></div>
  <div id="key-indicator">Jumlah Kunci: <span id="key-count">10</span></div>

  <button id="open-box-btn">Buka Kotak</button>

  <div id="box-result"></div>

  <div id="top-tier">
    <h3>Top 3 Penarik Terbesar</h3>
    <ul id="top-list">
      <li>Loading...</li>
    </ul>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
  // Config Firebase kamu
  const firebaseConfig = {
    apiKey: "AIzaSyA3-34rf9VZUIrAIR6z4BJtQm_MClqXm-Q",
    authDomain: "uangduty.firebaseapp.com",
    databaseURL: "https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "uangduty",
    storageBucket: "uangduty.firebasestorage.app",
    messagingSenderId: "598905752132",
    appId: "1:598905752132:web:7be400c23de21665044a11",
    measurementId: "G-TJL9K6YDL9"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Elemen DOM
  const totalMoneyEl = document.getElementById('total-money');
  const keyCountEl = document.getElementById('key-count');
  const openBoxBtn = document.getElementById('open-box-btn');
  const boxResultEl = document.getElementById('box-result');
  const topListEl = document.getElementById('top-list');

  // Data lokal pemain (dummy)
  let playerName = prompt("Masukkan nama kamu:") || "Player";
  let keys = 10; // kunci awal
  let totalMoney = 50000000; // 50jt
  let topTiers = {}; // nama -> total penarikan

  // Update UI awal
  keyCountEl.textContent = keys;
  totalMoneyEl.textContent = totalMoney.toLocaleString();

  // Fungsi update data total uang ke Firebase
  function updateTotalMoney(newAmount) {
    db.ref('totalMoney').set(newAmount);
  }

  // Fungsi update top tier ke Firebase
  function updateTopTier(name, amount) {
    db.ref('topTier/' + name).transaction(current => {
      return (current || 0) + amount;
    });
  }

  // Fungsi buka kotak (menarik uang)
  openBoxBtn.addEventListener('click', () => {
    if (keys <= 0) {
      boxResultEl.textContent = 'Kunci habis, tidak bisa buka kotak.';
      openBoxBtn.disabled = true;
      return;
    }
    if (totalMoney <= 0) {
      boxResultEl.textContent = 'Uang sudah habis, permainan selesai.';
      openBoxBtn.disabled = true;
      return;
    }

    // Kurangi kunci
    keys--;
    keyCountEl.textContent = keys;

    // Tentukan jumlah penarikan (random)
    let penarikan = Math.floor(Math.random() * 1000000) + 100000; // 100rb s/d 1jt

    // Pastikan tidak lebih dari total uang yang tersisa
    if (penarikan > totalMoney) penarikan = totalMoney;

    totalMoney -= penarikan;

    // Update ke Firebase total uang
    updateTotalMoney(totalMoney);

    // Update top tier nama player dengan jumlah penarikan
    updateTopTier(playerName, penarikan);

    // Update tampilan uang & hasil
    totalMoneyEl.textContent = totalMoney.toLocaleString();
    boxResultEl.textContent = `Kamu menarik Rp ${penarikan.toLocaleString()}. Sisa uang: Rp ${totalMoney.toLocaleString()}`;

    if (keys === 0) openBoxBtn.disabled = true;
  });

  // Listener realtime totalMoney dari Firebase
  db.ref('totalMoney').on('value', snapshot => {
    const val = snapshot.val();
    if (val !== null) {
      totalMoney = val;
      totalMoneyEl.textContent = totalMoney.toLocaleString();

      if (totalMoney <= 0) {
        boxResultEl.textContent = 'Uang sudah habis, permainan selesai.';
        openBoxBtn.disabled = true;
      }
    }
  });

  // Listener realtime topTier dari Firebase, update top 3
  db.ref('topTier').on('value', snapshot => {
    const data = snapshot.val() || {};
    // Ubah objek jadi array dan sort descending berdasarkan value (penarikan)
    let arr = Object.entries(data).sort((a,b) => b[1] - a[1]);
    let top3 = arr.slice(0,3);

    if (top3.length === 0) {
      topListEl.innerHTML = '<li>Belum ada penarikan.</li>';
      return;
    }

    topListEl.innerHTML = ''; // reset list
    top3.forEach(([name, amount], i) => {
      let li = document.createElement('li');
      li.textContent = `${i+1}. ${name} - Rp ${amount.toLocaleString()}`;
      topListEl.appendChild(li);
    });
  });

  // Inisialisasi totalMoney dan topTier di Firebase jika belum ada
  db.ref('totalMoney').once('value').then(snapshot => {
    if (snapshot.val() === null) {
      updateTotalMoney(50000000);
    }
  });
  db.ref('topTier').once('value').then(snapshot => {
    if (snapshot.val() === null) {
      db.ref('topTier').set({});
    }
  });

</script>

</body>
</html>
