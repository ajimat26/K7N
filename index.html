<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>UangDuty Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 10px;
    }
    h1 {
      color: #333;
      font-size: 20px;
    }
    .card {
      background: white;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.2s;
    }
    .card:hover {
      background: #f0f0f0;
    }
    .riwayat {
      display: none;
      margin-top: 8px;
      font-size: 14px;
      color: #555;
    }
    .total {
      font-weight: bold;
      color: green;
    }
    .info-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .dropdown {
      font-size: 14px;
      padding: 3px 6px;
    }
    .badge {
      background-color: gold;
      color: black;
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 12px;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <h1>üìä Uang Duty SAFD</h1>

  <div class="info-bar">
    <span id="timer">Refresh dalam: 60 detik</span>
    <select id="refreshControl" class="dropdown">
      <option value="60000">Setiap 1 menit</option>
      <option value="120000">Setiap 2 menit</option>
      <option value="0">Mati</option>
    </select>
  </div>

  <div id="data-container">Memuat data...</div>

  <script>
    let countdown = 60;
    let refreshInterval = 60000; // default 1 menit
    let intervalId = null;

    const container = document.getElementById("data-container");
    const timerDisplay = document.getElementById("timer");
    const refreshSelect = document.getElementById("refreshControl");

    function formatRupiah(angka) {
      return 'Rp. ' + angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function updateTimerDisplay() {
      timerDisplay.textContent = `Refresh dalam: ${countdown} detik`;
    }

    function startCountdown() {
      clearInterval(intervalId);
      if (refreshInterval === 0) {
        timerDisplay.textContent = "Auto refresh dimatikan";
        return;
      }
      countdown = refreshInterval / 1000;
      updateTimerDisplay();
      intervalId = setInterval(() => {
        countdown--;
        if (countdown <= 0) {
          loadData();
          countdown = refreshInterval / 1000;
        }
        updateTimerDisplay();
      }, 1000);
    }

    refreshSelect.addEventListener("change", () => {
      refreshInterval = parseInt(refreshSelect.value);
      startCountdown();
    });

    function loadData() {
      fetch("https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data.json")
        .then(res => res.json())
        .then(data => {
          container.innerHTML = "";
          if (!data) return;

          // Urutkan berdasarkan jumlah uang tertinggi
          const sorted = Object.entries(data).sort((a, b) => (b[1].uang || 0) - (a[1].uang || 0));

          let rank = 1;
          for (const [nama, pemain] of sorted) {
            const div = document.createElement("div");
            div.className = "card";

            const total = formatRupiah(pemain.uang || 0);
            const tag = rank === 1 ? `<span class="badge">ü•á Juara 1</span>` :
                        rank === 2 ? `<span class="badge">ü•à Juara 2</span>` :
                        rank === 3 ? `<span class="badge">ü•â Juara 3</span>` : "";

            const waktuUpdate = pemain.updated_at ? new Date(pemain.updated_at).toLocaleString("id-ID") : "Tidak diketahui";
            const riwayatHTML = pemain.riwayat && pemain.riwayat.length > 0 ?
              pemain.riwayat.map(r => "‚Ä¢ " + r).join("<br>") : "Tidak ada riwayat";

            div.innerHTML = `
              <strong>üìõ ${pemain.nama}</strong> ${tag}<br>
              <span class="total">Total Uang: ${total}</span><br>
              <small>‚è∞ Pembaruan: ${waktuUpdate}</small>
              <div class="riwayat">
                <br><u>üìú Riwayat:</u><br>${riwayatHTML}
                <br><br><button onclick="this.parentElement.style.display='none'; event.stopPropagation()">Tutup Riwayat</button>
              </div>
              <div style="text-align:right;margin-top:5px;">
                <button onclick="showMenu('${nama}', this); event.stopPropagation()">‚ãÆ</button>
              </div>`;

            div.addEventListener("click", () => {
              const r = div.querySelector(".riwayat");
              r.style.display = r.style.display === "none" ? "block" : "none";
            });

            container.appendChild(div);
            rank++;
          }
        })
        .catch(err => {
          container.innerHTML = "Gagal memuat data.";
          console.error(err);
        });
    }

    function showMenu(nama, button) {
      const menu = document.createElement("div");
      menu.style.position = "absolute";
      menu.style.background = "white";
      menu.style.border = "1px solid #ccc";
      menu.style.padding = "5px";
      menu.style.boxShadow = "0 2px 4px rgba(0,0,0,0.2)";
      menu.innerHTML = `
        <button onclick="ubahNama('${nama}')">Ubah Nama</button><br>
        <button onclick="hapusForum('${nama}')">Hapus Forum</button>
      `;
      document.body.appendChild(menu);
      const rect = button.getBoundingClientRect();
      menu.style.left = `${rect.left}px`;
      menu.style.top = `${rect.bottom}px`;
      const removeMenu = () => {
        document.body.removeChild(menu);
        document.removeEventListener("click", removeMenu);
      };
      setTimeout(() => document.addEventListener("click", removeMenu), 0);
    }

    function ubahNama(namaLama) {
      const namaBaru = prompt("Masukkan nama baru:", namaLama);
      if (!namaBaru) return;
      fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${namaLama}.json`)
        .then(res => res.json())
        .then(data => {
          fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${namaLama}.json`, { method: "DELETE" });
          fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${namaBaru}.json`, {
            method: "PUT",
            body: JSON.stringify({...data, nama: namaBaru})
          }).then(() => loadData());
        });
    }

    function hapusForum(nama) {
      if (!confirm("Yakin ingin menghapus forum ini?")) return;
      fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${nama}.json`, {
        method: "DELETE"
      }).then(() => loadData());
    }

    loadData();
    startCountdown();
  </script>
</body>
</html>
