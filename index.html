<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UangDuty Database live on</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 10px;
      background: #f9f9f9;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      margin-bottom: 5px;
    }

    .top-one {
      text-align: right;
      font-size: 12px;
    }

    .running-container {
      background: black;
      color: white;
      padding: 5px;
      overflow: hidden;
      margin-bottom: 10px;
      border-radius: 5px;
      position: relative;
    }

    .running-text {
      display: inline-block;
      white-space: nowrap;
      position: absolute;
      will-change: transform;
      animation: scroll-left 25s linear infinite;
    }

    @keyframes scroll-left {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }

    .card {
      background: white;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      position: relative;
    }

    .card .menu {
      position: absolute;
      top: 5px;
      right: 10px;
      font-size: 18px;
      cursor: pointer;
    }

    .card .dropdown {
      display: none;
      position: absolute;
      top: 25px;
      right: 10px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
      z-index: 10;
    }

    .dropdown div {
      padding: 5px 10px;
      cursor: pointer;
    }

    .dropdown div:hover {
      background: #eee;
    }

    .riwayat {
      display: none;
      font-size: 13px;
      margin-top: 5px;
    }

    .total {
      font-weight: bold;
      color: green;
    }

    .button {
      margin-top: 5px;
      padding: 5px 10px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
    }

    .button:hover {
      background: #0056b3;
    }

    #refresh-controls {
      font-size: 12px;
      margin: 5px 0;
    }

    #search {
      width: 100%;
      padding: 5px;
      font-size: 14px;
      margin: 10px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

  <div class="top-bar">
    <div>
      ‚è±Ô∏è Refresh: <span id="countdown">60</span>s
      <select id="interval">
        <option value="0">Mati</option>
        <option value="60" selected>1 menit</option>
        <option value="120">2 menit</option>
        <option value="180">3 menit</option>
        <option value="300">5 menit</option>
      </select>
    </div>
    <div class="top-one">
      <b>üèÜ Top 1</b><br>
      <span id="top-one-text">-</span>
    </div>
  </div>

  <div class="running-container">
    <div class="running-text" id="running-text">Memuat riwayat terbaru...</div>
  </div>

  <input type="text" id="search" placeholder="üîç Cari nama forum..." />

  <div id="data-container">Memuat data...</div>

  <script>
    let refreshSeconds = 60;
    let intervalId;
    let isInteracting = false;

    const countdownEl = document.getElementById('countdown');
    const intervalSelect = document.getElementById('interval');
    const runningText = document.getElementById('running-text');
    const searchInput = document.getElementById('search');
    const topOneText = document.getElementById('top-one-text');

    intervalSelect.addEventListener('change', () => {
      refreshSeconds = parseInt(intervalSelect.value);
      restartTimer();
    });

    function restartTimer() {
      clearInterval(intervalId);
      if (refreshSeconds > 0) {
        intervalId = setInterval(() => {
          if (!isInteracting) {
            countdownEl.textContent = refreshSeconds;
            refreshSeconds--;
            if (refreshSeconds <= 0) {
              fetchData();
              refreshSeconds = parseInt(intervalSelect.value);
            }
          }
        }, 1000);
      }
    }

    document.body.addEventListener('click', () => isInteracting = true);
    setInterval(() => isInteracting = false, 10000);

    function formatRupiah(num) {
      return "Rp. " + num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function fetchData() {
      fetch("https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data.json")
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById("data-container");
          container.innerHTML = "";
          const search = searchInput.value.toLowerCase();

          const sorted = Object.entries(data || {}).sort((a,b)=> (b[1].uang||0)-(a[1].uang||0));

          // Top 1
          if (sorted.length > 0) {
            const topUser = sorted[0][1];
            topOneText.textContent = `${topUser.nama} - ${formatRupiah(topUser.uang || 0)}`;
          }

          // Running Text
          let allRiwayat = [];
          sorted.forEach(([nama, d]) => {
            (d.riwayat||[]).forEach(r => {
              allRiwayat.push(`${d.nama}: ${r}`);
            });
          });
          runningText.textContent = allRiwayat.slice(-10).reverse().join(" | ");

          sorted.forEach(([nama, pemain]) => {
            if (!pemain.nama.toLowerCase().includes(search)) return;

            const div = document.createElement("div");
            div.className = "card";
            div.innerHTML = `
              <strong>üìõ ${pemain.nama}</strong><br>
              <span class="total">Total Uang: ${formatRupiah(pemain.uang || 0)}</span><br>
              <small>üïí Terakhir diperbarui: ${pemain.riwayat && pemain.riwayat.length ? pemain.riwayat[pemain.riwayat.length-1].split(" | ")[0] : '-'}</small>
              <button class="button" onclick="toggleRiwayat(this)">üìú Lihat Riwayat</button>
              <div class="riwayat">
                ${(pemain.riwayat || []).map(r => "‚Ä¢ " + r).join("<br>") || "Tidak ada riwayat"}
              </div>
              <div class="menu" onclick="toggleDropdown(this)">‚ãÆ</div>
              <div class="dropdown">
                <div onclick="renameForum('${nama}')">‚úèÔ∏è Ubah Nama</div>
                <div onclick="hapusForum('${nama}')">üóëÔ∏è Hapus Forum</div>
              </div>
            `;
            container.appendChild(div);
          });
        });
    }

    function toggleRiwayat(btn) {
      const riwayat = btn.nextElementSibling;
      riwayat.style.display = riwayat.style.display === "block" ? "none" : "block";
      btn.textContent = riwayat.style.display === "block" ? "üîΩ Tutup Riwayat" : "üìú Lihat Riwayat";
    }

    function toggleDropdown(el) {
      const dd = el.nextElementSibling;
      dd.style.display = dd.style.display === "block" ? "none" : "block";
    }

    function renameForum(nama) {
      const baru = prompt("Masukkan nama baru:");
      if (baru) {
        fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${nama}.json`)
          .then(res => res.json())
          .then(data => {
            fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${nama}.json`, { method: "DELETE" });
            data.nama = baru;
            fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${baru}.json`, {
              method: "PUT",
              body: JSON.stringify(data)
            }).then(() => fetchData());
          });
      }
    }

    function hapusForum(nama) {
      if (confirm("Yakin ingin menghapus forum ini?")) {
        fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${nama}.json`, {
          method: "DELETE"
        }).then(() => fetchData());
      }
    }

    searchInput.addEventListener("input", fetchData);
    fetchData();
    restartTimer();
  </script>

</body>
</html>
