<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>UangDuty - SAFD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; background: #f4f4f4; }
    h1 { color: #333; font-size: 20px; }
    .running-text {
      background: #000; color: #0f0; padding: 5px; overflow: hidden; white-space: nowrap;
    }
    .scrolling {
      display: inline-block;
      animation: scroll-left 140s linear infinite;
    }
    @keyframes scroll-left {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }
    .card {
      background: #fff; padding: 10px; border-radius: 10px; margin-bottom: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative;
    }
    .total { font-weight: bold; color: green; font-size: 15px; }
    .riwayat { display: none; font-size: 13px; color: #555; margin-top: 5px; }
    .menu-button {
      position: absolute; top: 10px; right: 10px; background: none; border: none;
      font-size: 20px; cursor: pointer;
    }
    .menu { display: none; position: absolute; right: 10px; top: 35px;
      background: #fff; border: 1px solid #ccc; border-radius: 5px; z-index: 100;
    }
    .menu button {
      display: block; width: 100%; border: none; background: none;
      padding: 5px 10px; text-align: left; cursor: pointer;
    }
    .badge { background: gold; color: #000; padding: 2px 5px; font-size: 11px;
      border-radius: 5px; margin-left: 5px; }
    .updated-time { font-size: 11px; color: #777; margin-top: 5px; }
    .toggle-btn {
      font-size: 13px; color: #0066cc; cursor: pointer; margin-top: 5px;
      display: inline-block;
    }
  </style>
</head>
<body>

  <h1>üíº UangDuty - SAFD</h1>
  <div class="running-text" id="running">
    <span class="scrolling" id="running-content">Memuat riwayat...</span>
  </div>
  <br>
  <div id="data-container">Memuat data...</div>

  <script>
    let pausedUsers = {}; // Menyimpan pengguna yang sedang buka riwayat/menu
    let latestRiwayats = [];

    function formatRupiah(angka) {
      return 'Rp. ' + angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function refreshData() {
      fetch("https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data.json")
        .then(res => res.json())
        .then(data => {
          const sorted = Object.entries(data || {}).sort((a, b) => (b[1].uang || 0) - (a[1].uang || 0));
          const container = document.getElementById("data-container");
          container.innerHTML = "";
          latestRiwayats = [];

          sorted.forEach(([nama, info], index) => {
            const uang = formatRupiah(info.uang || 0);
            const tag = index == 0 ? "Juara 1" : index == 1 ? "Juara 2" : index == 2 ? "Juara 3" : null;
            const paused = pausedUsers[nama];

            const div = document.createElement("div");
            div.className = "card";

            let html = `<strong>üìõ ${info.nama}`;
            if (tag) html += `<span class="badge">${tag}</span>`;
            html += `</strong><br><span class="total">Total Uang: ${uang}</span><br>`;
            html += `<span class="updated-time">‚è±Ô∏è Diperbarui: ${new Date().toLocaleTimeString()}</span><br>`;
            html += `<span class="toggle-btn" onclick="toggleRiwayat('${nama}')">Lihat Riwayat</span>`;
            html += `<div class="riwayat" id="rwt-${nama}"><br><u>üìú Riwayat:</u><br>${
              info.riwayat && info.riwayat.length > 0 ? info.riwayat.map(r => "‚Ä¢ " + r).join("<br>") : "Tidak ada riwayat"
            }<br><span class="toggle-btn" onclick="toggleRiwayat('${nama}')">Tutup Riwayat</span></div>`;
            html += `<button class="menu-button" onclick="toggleMenu('${nama}')">‚ãÆ</button>`;
            html += `<div class="menu" id="menu-${nama}">
                      <button onclick="ubahNama('${nama}')">Ubah Nama</button>
                      <button onclick="hapusForum('${nama}')">Hapus Forum</button>
                    </div>`;

            div.innerHTML = html;
            container.appendChild(div);

            // Kumpulkan riwayat untuk running text
            if (info.riwayat) {
              info.riwayat.forEach(r => {
                latestRiwayats.push(`${info.nama}: ${r}`);
              });
            }

            if (!paused) document.getElementById(`rwt-${nama}`).style.display = "none";
          });

          document.getElementById("running-content").textContent = latestRiwayats.slice(-20).join(" ‚Ä¢ ");
        });
    }

    function toggleRiwayat(nama) {
      const r = document.getElementById("rwt-" + nama);
      const isOpen = r.style.display === "block";
      r.style.display = isOpen ? "none" : "block";
      pausedUsers[nama] = !isOpen;
    }

    function toggleMenu(nama) {
      const m = document.getElementById("menu-" + nama);
      const isVisible = m.style.display === "block";
      document.querySelectorAll(".menu").forEach(e => e.style.display = "none");
      m.style.display = isVisible ? "none" : "block";
      pausedUsers[nama] = !isVisible;
    }

    function ubahNama(nama) {
      const baru = prompt("Masukkan nama baru:", nama);
      if (!baru) return;
      fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${nama}.json`, {
        method: "PATCH",
        body: JSON.stringify({ nama: baru }),
        headers: { "Content-Type": "application/json" }
      }).then(() => {
        fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${baru}.json`, {
          method: "PATCH",
          body: JSON.stringify({}),
          headers: { "Content-Type": "application/json" }
        });
        fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${nama}.json`, { method: "DELETE" });
      });
    }

    function hapusForum(nama) {
      if (confirm("Yakin ingin menghapus forum ini?")) {
        fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${nama}.json`, { method: "DELETE" });
      }
    }

    setInterval(refreshData, 1000);
    refreshData();
  </script>
</body>
</html>
