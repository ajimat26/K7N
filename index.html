<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>UangDuty Viewer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 10px;
    }
    h1 {
      color: #333;
      text-align: center;
    }
    #marquee {
      background: black;
      color: white;
      padding: 8px;
      overflow: hidden;
      white-space: nowrap;
      box-sizing: border-box;
    }
    .card {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: relative;
    }
    .total { font-weight: bold; color: green; }
    .riwayat { display: none; margin-top: 10px; font-size: 14px; color: #555; }
    .btn {
      padding: 5px 10px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      margin-top: 5px;
      margin-right: 5px;
    }
    .btn:hover { background: #0056b3; cursor: pointer; }
    .menu {
      position: absolute;
      top: 10px;
      right: 10px;
    }
    .menu-content {
      display: none;
      position: absolute;
      right: 0;
      background-color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 1;
      border-radius: 6px;
    }
    .menu-content button {
      display: block;
      width: 100%;
      padding: 8px;
      background: white;
      border: none;
      text-align: left;
    }
    .menu-content button:hover {
      background: #eee;
    }
    .menu:hover .menu-content {
      display: block;
    }
    .tag {
      font-weight: bold;
      margin-left: 5px;
    }
    .timestamp {
      font-size: 11px;
      color: #888;
      margin-top: 5px;
    }
  </style>
</head>
<body>

  <h1>üìä UangDuty SAFD</h1>
  <div id="marquee">Memuat riwayat...</div>
  <div id="data-container">Memuat data...</div>

  <script>
    let riwayatAktif = false;
    let opsiAktif = false;

    function formatRupiah(angka) {
      return 'Rp. ' + angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function formatTime(date) {
      return date.toLocaleTimeString("id-ID", { hour: '2-digit', minute: '2-digit' });
    }

    function loadData() {
      fetch("https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data.json")
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById("data-container");
          const marquee = document.getElementById("marquee");
          container.innerHTML = "";
          let riwayatList = [];

          // Ubah objek jadi array & urutkan berdasarkan uang
          const entries = Object.entries(data || {}).map(([nama, d]) => ({
            nama,
            uang: d.uang || 0,
            riwayat: d.riwayat || [],
            updated: d.riwayat && d.riwayat.length > 0 ? d.riwayat[d.riwayat.length - 1] : "Tidak diketahui"
          })).sort((a, b) => b.uang - a.uang);

          entries.forEach((pemain, index) => {
            const tag = index === 0 ? "ü•á" : index === 1 ? "ü•à" : index === 2 ? "ü•â" : "";
            const div = document.createElement("div");
            div.className = "card";

            // Running Text
            pemain.riwayat.forEach(r => riwayatList.push(`${pemain.nama}: ${r}`));

            div.innerHTML = `
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                  <strong>üìõ ${pemain.nama}</strong> ${tag}<br>
                  <span class="total">Total Uang: ${formatRupiah(pemain.uang)}</span><br>
                  <div class="timestamp">üïí Terakhir diperbarui: ${pemain.updated}</div>
                </div>
                <div class="menu">
                  <span>‚ãÆ</span>
                  <div class="menu-content">
                    <button onclick="ubahNama('${pemain.nama}')">‚úèÔ∏è Ubah Nama</button>
                    <button onclick="hapusForum('${pemain.nama}')">üóëÔ∏è Hapus Forum</button>
                  </div>
                </div>
              </div>
              <div class="riwayat">
                <br><u>üìú Riwayat:</u><br>
                ${pemain.riwayat.length > 0 ? pemain.riwayat.map(r => "‚Ä¢ " + r).join("<br>") : "Tidak ada riwayat"}<br>
                <button class="btn" onclick="toggleRiwayat(this)">‚ùå Tutup Riwayat</button>
              </div>
              <button class="btn" onclick="toggleRiwayat(this)">üìú Lihat Riwayat</button>
            `;
            container.appendChild(div);
          });

          marquee.innerText = "üì∞ " + riwayatList.reverse().slice(0, 20).join(" ‚ö´ ");
        })
        .catch(err => {
          document.getElementById("data-container").innerHTML = "Gagal memuat data.";
        });
    }

    function toggleRiwayat(button) {
      const riwayat = button.parentElement.querySelector(".riwayat");
      if (riwayat.style.display === "block") {
        riwayat.style.display = "none";
        button.innerText = "üìú Lihat Riwayat";
      } else {
        riwayat.style.display = "block";
        button.innerText = "‚ùå Tutup Riwayat";
      }
    }

    function ubahNama(nama) {
      const baru = prompt("Masukkan nama baru untuk forum:", nama);
      if (baru && baru !== nama) {
        fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${nama}.json`, { method: "DELETE" });
        fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${baru}.json`, {
          method: "PUT",
          body: JSON.stringify({ nama: baru }),
          headers: { "Content-Type": "application/json" }
        }).then(() => loadData());
      }
    }

    function hapusForum(nama) {
      if (confirm(`Yakin ingin menghapus forum "${nama}"?`)) {
        fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${nama}.json`, {
          method: "DELETE"
        }).then(() => loadData());
      }
    }

    loadData();
    setInterval(() => {
      if (![...document.querySelectorAll(".riwayat")].some(r => r.style.display === "block")) {
        loadData();
      }
    }, 60000); // 1 menit
  </script>
</body>
</html>
