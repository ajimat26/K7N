<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>K7N PROJECT - LOGIN</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{--blue:#6AB8FF;--bg:#0D0014;--card:#101322}
*{box-sizing:border-box}
body{margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:var(--bg);font-family:Montserrat,Arial,sans-serif;color:#E0E0E0;padding:20px}
.card{width:100%;max-width:420px;background:var(--card);border:1px solid rgba(106,184,255,0.18);padding:24px;border-radius:14px;box-shadow:0 6px 30px rgba(10,20,30,0.6)}
h1{font-family:Orbitron,monospace;color:var(--blue);text-align:center;margin-bottom:18px}
.logo{display:block;width:110px;height:110px;border-radius:50%;object-fit:cover;margin:0 auto 14px;border:3px solid var(--blue);box-shadow:0 0 12px rgba(106,184,255,0.45)}
input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(106,184,255,0.12);background:#0f1720;color:#E0E0E0;margin-bottom:12px;font-size:15px}
button{width:100%;padding:14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--blue),#3399FF);color:#00111a;font-weight:700;cursor:pointer;font-size:16px}
button:active{transform:translateY(1px)}
#msg{height:18px;margin-top:10px;text-align:center;font-size:14px;color:#ff8b8b}
/* video overlay */
#videoOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.92);z-index:9999}
#videoOverlay.active{display:flex}
#loginVideo{width:84%;max-width:720px;border-radius:10px}
</style>
</head>
<body>
<div id="videoOverlay">
  <video id="loginVideo" playsinline>
    <source src="https://files.catbox.moe/mksc7a.mp4" type="video/mp4">
    Your browser does not support video.
  </video>
</div>

<div class="card" role="main" aria-labelledby="title">
  <h1 id="title">K7N X WAR CRASH</h1>
  <img src="https://i.supaimg.com/9775bd8b-667c-4ea3-8173-b27aeee837bc.jpg" alt="logo" class="logo" />
  
  <label for="username" style="display:none">Username</label>
  <input id="username" autocomplete="username" placeholder="Username" inputmode="text" />
  
  <label for="password" style="display:none">Password</label>
  <input id="password" type="password" autocomplete="current-password" placeholder="Password" />
  
  <button id="btnLogin" type="button">LOGIN</button>
  
  <div id="msg" role="status" aria-live="polite"></div>
</div>

<script>
(function(){

/* ================== CONFIG ================== */
const DB_KEY = "K7N_DB_V1";
const SESSION_KEY = "K7N_SESSION_V1";
const TRIAL_META_KEY = "TRIAL_META_V1";
const TRIAL_USED_KEY = "TRIAL_USED_V1";

const TRIAL_USERNAME = "TRIAL";
const TRIAL_PASSWORD = "T30";
const TRIAL_DURATION = 30 * 60 * 1000; // 30 menit

const REMOTE_DB = "https://raw.githubusercontent.com/ajimat26/ajimat26.github.io/main/K7NN/data/database.json";
const DASHBOARD_URL = "http://serverpublik-pirzy.anti-ddos.me:2019/dashboard";

const defaultAdmin = {
  username: "K7N",
  password: "nvrz",
  role: "OWNER",
  expired: "NEVER"
};

/* ================== UTIL ================== */
function setMsg(text, color){
  const el = document.getElementById("msg");
  el.textContent = text || "";
  el.style.color = color || "";
}

function now(){ return Date.now(); }

/* ================== DB INIT ================== */
function initLocalDB(){
  try {
    const raw = localStorage.getItem(DB_KEY);
    if (!raw) {
      const db = { accounts: [ defaultAdmin ] };
      localStorage.setItem(DB_KEY, JSON.stringify(db));
      return db;
    }
    return JSON.parse(raw);
  } catch {
    const db = { accounts: [ defaultAdmin ] };
    localStorage.setItem(DB_KEY, JSON.stringify(db));
    return db;
  }
}

async function fetchRemoteDB(){
  try {
    const res = await fetch(REMOTE_DB, { cache: "no-store" });
    if (!res.ok) throw 0;
    const json = await res.json();
    localStorage.setItem(DB_KEY, JSON.stringify(json));
    return json;
  } catch {
    return null;
  }
}

/* ================== TRIAL LOGIC ================== */
function isTrialExpired(){
  const meta = JSON.parse(localStorage.getItem(TRIAL_META_KEY) || "null");
  if (!meta) return false;
  return now() > meta.expiredAt;
}

function markTrialUsed(){
  localStorage.setItem(TRIAL_USED_KEY, "true");
  localStorage.removeItem(TRIAL_META_KEY);
  localStorage.removeItem(SESSION_KEY);
}

function startTrialSession(){
  const meta = {
    startedAt: now(),
    expiredAt: now() + TRIAL_DURATION
  };
  localStorage.setItem(TRIAL_META_KEY, JSON.stringify(meta));

  const session = {
    username: "TRIAL",
    role: "TRIAL",
    expired: new Date(meta.expiredAt).toISOString(),
    createdAt: new Date().toISOString(),
    isTrial: true
  };
  localStorage.setItem(SESSION_KEY, JSON.stringify(session));

  // Set timer auto logout
  setTimeout(() => {
    alert("Masa TRIAL sudah habis!");
    markTrialUsed();
    location.reload(); // redirect ke login setelah logout
  }, TRIAL_DURATION);
}

/* ================== LOGIN ================== */
async function loginUser(){
  setMsg("");

  const user = username.value.trim();
  const pass = password.value;

  if (!user || !pass){
    setMsg("Isi username & password", "#ff8b8b");
    return;
  }

  /* ===== TRIAL ACCOUNT ===== */
  if (user === TRIAL_USERNAME && pass === TRIAL_PASSWORD){

    if (localStorage.getItem(TRIAL_USED_KEY)){
      setMsg("Akun TRIAL sudah digunakan.", "#ff8b8b");
      return;
    }

    if (isTrialExpired()){
      markTrialUsed();
      setMsg("Masa TRIAL sudah habis.", "#ff8b8b");
      return;
    }

    if (!localStorage.getItem(TRIAL_META_KEY)){
      startTrialSession();
    }

    playAndRedirect();
    return;
  }

  /* ===== NORMAL ACCOUNT ===== */
  let db = initLocalDB();
  fetchRemoteDB().then(r => r && (db = r));

  const acc = (db.accounts || []).find(a =>
    a.username === user && a.password === pass
  );

  if (!acc){
    setMsg("Username atau password salah.", "#ff8b8b");
    return;
  }

  const session = {
    username: acc.username,
    role: acc.role || "USER",
    expired: acc.expired || "NEVER",
    createdAt: new Date().toISOString()
  };

  localStorage.setItem(SESSION_KEY, JSON.stringify(session));
  playAndRedirect();
}

/* ================== VIDEO ================== */
function playAndRedirect(){
  const overlay = videoOverlay;
  const video = loginVideo;
  overlay.classList.add("active");

  const p = video.play();
  if (p?.then){
    p.then(() => video.onended = () => location.href = DASHBOARD_URL)
     .catch(() => location.href = DASHBOARD_URL);
  } else {
    setTimeout(() => location.href = DASHBOARD_URL, 1500);
  }
}

/* ================== AUTO TRIAL CHECK ================== */
(function autoTrialCheck(){
  if (isTrialExpired()){
    markTrialUsed();
  }
  // jika ada TRIAL session aktif -> langsung redirect
  const session = JSON.parse(localStorage.getItem(SESSION_KEY) || "null");
  if(session?.isTrial){
    playAndRedirect();
  }
})();

/* ================== EVENTS ================== */
btnLogin.onclick = loginUser;
document.addEventListener("keydown", e => {
  if (e.key === "Enter") loginUser();
});

initLocalDB();

})();
</script>
</body>
</html>
