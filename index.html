<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UangDuty Viewer</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 10px; margin: 0; }
    h1 { font-size: 20px; color: #333; }
    .card {
      background: white;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: relative;
    }
    .card-header { display: flex; justify-content: space-between; align-items: center; }
    .card strong { font-size: 16px; }
    .total { color: green; font-weight: bold; font-size: 14px; }
    .updated { font-size: 12px; color: #888; }
    .riwayat { display: none; margin-top: 10px; font-size: 13px; color: #444; }
    .btn { background: #eee; border: none; padding: 6px 10px; margin-top: 6px; border-radius: 6px; font-size: 13px; }
    .btn:hover { background: #ddd; cursor: pointer; }

    .options-menu {
      position: absolute;
      top: 36px;
      right: 10px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 10;
      display: none;
    }
    .options-menu div {
      padding: 8px 12px;
      font-size: 13px;
      cursor: pointer;
    }
    .options-menu div:hover {
      background: #f0f0f0;
    }

    .running {
      background: black;
      color: white;
      overflow: hidden;
      white-space: nowrap;
      box-sizing: border-box;
      padding: 8px;
      margin: 10px 0;
    }

    .marquee {
      display: inline-block;
      animation: marquee 100s linear infinite;
    }

    @keyframes marquee {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }
  </style>
</head>
<body>
  <h1>üíº Uang Duty - SAFD</h1>
  <div class="running"><div id="marquee" class="marquee">Memuat riwayat...</div></div>
  <div id="data-container">Memuat data...</div>

  <script>
    let isInteracting = false;
    let lastInteraction = Date.now();

    function formatRupiah(angka) {
      return 'Rp. ' + angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function setInteracting() {
      isInteracting = true;
      lastInteraction = Date.now();
    }

    function buatForum(data) {
      const container = document.getElementById("data-container");
      container.innerHTML = "";

      // Urutkan berdasarkan uang (besar ke kecil)
      const arr = Object.entries(data || {}).sort((a, b) => (b[1].uang || 0) - (a[1].uang || 0));

      const top3 = arr.slice(0, 3).map(entry => entry[0]);

      arr.forEach(([nama, pemain], index) => {
        const div = document.createElement("div");
        div.className = "card";

        const total = formatRupiah(pemain.uang || 0);
        const updated = pemain.updated_at || "Tidak diketahui";
        const isTop3 = top3.includes(nama);

        const tag = isTop3 ? `<span style="color:gold; font-size:12px;">üèÜ Juara ${top3.indexOf(nama)+1}</span>` : "";

        div.innerHTML = `
          <div class="card-header">
            <div>
              <strong>${pemain.nama}</strong> ${tag}<br>
              <span class="total">Total Uang: ${total}</span><br>
              <span class="updated">üìÖ Update: ${updated}</span>
            </div>
            <div>
              <button class="btn" onclick="toggleRiwayat(this)">Lihat Riwayat</button>
              <button class="btn" onclick="toggleOptions(this)">‚ãÆ</button>
              <div class="options-menu">
                <div onclick="ubahNama('${nama}')">‚úèÔ∏è Ubah Nama</div>
                <div onclick="hapusForum('${nama}')">üóëÔ∏è Hapus Forum</div>
              </div>
            </div>
          </div>
          <div class="riwayat">
            <br><u>üìú Riwayat:</u><br>
            ${pemain.riwayat && pemain.riwayat.length > 0 ? pemain.riwayat.map(r => "‚Ä¢ " + r).join("<br>") : "Tidak ada riwayat"}
            <br><button class="btn" onclick="tutupRiwayat(this)">Tutup Riwayat</button>
          </div>
        `;

        container.appendChild(div);
      });

      // Running text update
      const allRiwayat = arr.flatMap(([nama, p]) => (p.riwayat || []).map(r => `${p.nama}: ${r}`));
      document.getElementById("marquee").textContent = allRiwayat.join(" | ");
    }

    function toggleRiwayat(btn) {
      setInteracting();
      const card = btn.closest(".card");
      const riwayat = card.querySelector(".riwayat");
      riwayat.style.display = "block";
    }

    function tutupRiwayat(btn) {
      const card = btn.closest(".card");
      const riwayat = card.querySelector(".riwayat");
      riwayat.style.display = "none";
      setInteracting();
    }

    function toggleOptions(btn) {
      setInteracting();
      const menu = btn.nextElementSibling;
      menu.style.display = menu.style.display === "block" ? "none" : "block";
    }

    function ubahNama(nama) {
      setInteracting();
      const baru = prompt("Masukkan nama baru:");
      if (baru) {
        fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${nama}.json`, {
          method: "PATCH",
          body: JSON.stringify({ nama: baru }),
          headers: { "Content-Type": "application/json" }
        }).then(() => loadData());
      }
    }

    function hapusForum(nama) {
      setInteracting();
      if (confirm("Yakin ingin menghapus forum ini?")) {
        fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${nama}.json`, {
          method: "DELETE"
        }).then(() => loadData());
      }
    }

    function loadData() {
      fetch("https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data.json")
        .then(res => res.json())
        .then(data => buatForum(data))
        .catch(err => {
          document.getElementById("data-container").innerHTML = "Gagal memuat data.";
        });
    }

    // Timer: refresh tiap 20 detik jika tidak sedang berinteraksi
    setInterval(() => {
      const now = Date.now();
      if (!isInteracting || now - lastInteraction > 20000) {
        isInteracting = false;
        loadData();
      }
    }, 2000);

    loadData();
  </script>
</body>
</html>
