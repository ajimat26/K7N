<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>UangDuty Mobile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 10px; margin: 0; }
    h1 { font-size: 18px; color: #333; margin: 10px 0; }
    .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 5px; flex-wrap: wrap; }
    .dropdown, .search { font-size: 12px; padding: 5px; border-radius: 5px; border: 1px solid #ccc; flex-grow: 1; }
    .refresh-timer { font-size: 12px; color: gray; margin-bottom: 5px; }

    .card {
      background: white; padding: 10px; margin-bottom: 10px;
      border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: relative;
    }
    .total { font-weight: bold; color: green; font-size: 14px; }
    .riwayat { display: none; margin-top: 8px; font-size: 12px; color: #444; }
    .updated { font-size: 11px; color: #888; margin-top: 5px; }
    .tag { background: gold; color: black; font-size: 10px; padding: 2px 4px; border-radius: 4px; margin-left: 5px; }
    .menu { position: absolute; right: 10px; top: 10px; cursor: pointer; font-size: 16px; }

    .menu-options {
      position: absolute; top: 30px; right: 10px;
      background: #fff; border: 1px solid #ccc; border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: none; z-index: 999;
    }
    .menu-options div {
      padding: 5px 10px; font-size: 12px; cursor: pointer;
    }
    .menu-options div:hover { background: #eee; }

    .running-text {
      background: black; color: white;
      white-space: nowrap; overflow-x: auto;
      padding: 8px; font-size: 13px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>📊 UangDuty SAFD</h1>

  <div class="controls">
    <input type="text" class="search" placeholder="🔍 Cari nama..." oninput="searchForums(this.value)">
    <select class="dropdown" id="refreshSelect" onchange="updateRefreshInterval()">
      <option value="0">🔁 Auto Refresh: Mati</option>
      <option value="60">🔁 Setiap 1 Menit</option>
      <option value="120">🔁 Setiap 2 Menit</option>
      <option value="180">🔁 Setiap 3 Menit</option>
      <option value="300">🔁 Setiap 5 Menit</option>
    </select>
  </div>

  <div class="refresh-timer">⏱ Refresh dalam <span id="countdown">--</span> detik</div>
  <div class="running-text" id="runningText">Memuat riwayat terbaru...</div>
  <div id="data-container">Memuat data...</div>

  <script>
    let interval = 0;
    let timer = 0;
    let countdown = 0;
    let rawData = {};

    function updateRefreshInterval() {
      clearInterval(timer);
      interval = parseInt(document.getElementById("refreshSelect").value);
      if (interval > 0) {
        countdown = interval;
        timer = setInterval(() => {
          countdown--;
          document.getElementById("countdown").textContent = countdown;
          if (countdown <= 0) {
            loadData();
            countdown = interval;
          }
        }, 1000);
      } else {
        document.getElementById("countdown").textContent = "--";
      }
    }

    function formatRupiah(angka) {
      return 'Rp. ' + (angka || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function timeAgo(unixTime) {
      const d = new Date(unixTime * 1000);
      return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()} ${d.getHours()}:${d.getMinutes()}:${d.getSeconds()}`;
    }

    function searchForums(keyword) {
      keyword = keyword.toLowerCase();
      const cards = document.querySelectorAll(".card");
      cards.forEach(card => {
        const name = card.getAttribute("data-nama").toLowerCase();
        card.style.display = name.includes(keyword) ? "block" : "none";
      });
    }

    function renderRunningText(all) {
      const semuaRiwayat = [];
      for (let nama in all) {
        if (all[nama].riwayat) {
          all[nama].riwayat.forEach(r => {
            semuaRiwayat.push(`📛 ${nama}: ${r}`);
          });
        }
      }
      document.getElementById("runningText").textContent = semuaRiwayat.reverse().slice(0, 20).join(" | ");
    }

    function renderData(data) {
      const container = document.getElementById("data-container");
      container.innerHTML = "";
      const sorted = Object.entries(data).sort((a,b)=> (b[1].uang||0)-(a[1].uang||0));
      sorted.forEach(([nama, info], index) => {
        const div = document.createElement("div");
        div.className = "card";
        div.setAttribute("data-nama", nama);

        const tag = index === 0 ? ' 🥇' : index === 1 ? ' 🥈' : index === 2 ? ' 🥉' : '';
        const waktu = info.terakhir ? `<div class="updated">🕒 Update: ${timeAgo(info.terakhir)}</div>` : "";
        const total = formatRupiah(info.uang || 0);
        const riwayat = info.riwayat && info.riwayat.length > 0
          ? info.riwayat.map(r => "• " + r).join("<br>")
          : "Tidak ada riwayat";

        div.innerHTML = `<strong>📛 ${info.nama || nama}${tag}</strong><br>
                         <span class="total">Total Uang: ${total}</span>
                         ${waktu}
                         <div class="riwayat">
                           <br><u>📜 Riwayat:</u><br>${riwayat}
                         </div>
                         <div class="menu">⋮</div>
                         <div class="menu-options">
                           <div onclick="editNama('${nama}')">✏️ Ubah Nama</div>
                           <div onclick="hapusForum('${nama}')">🗑️ Hapus Forum</div>
                         </div>`;

        div.querySelector(".menu").onclick = e => {
          const opt = div.querySelector(".menu-options");
          opt.style.display = opt.style.display === "block" ? "none" : "block";
        };

        div.addEventListener("click", e => {
          if (!e.target.classList.contains("menu") && !e.target.closest(".menu-options")) {
            const r = div.querySelector(".riwayat");
            r.style.display = r.style.display === "block" ? "none" : "block";
          }
        });

        container.appendChild(div);
      });
    }

    function loadData() {
      fetch("https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data.json")
        .then(res => res.json())
        .then(data => {
          rawData = data;
          renderData(data);
          renderRunningText(data);
        })
        .catch(() => {
          document.getElementById("data-container").innerHTML = "⚠️ Gagal memuat data.";
        });
    }

    function editNama(nama) {
      const baru = prompt("Ubah nama forum:", nama);
      if (baru && baru !== nama) {
        const updated = {...rawData[nama], nama: baru};
        fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${nama}.json`, { method: "DELETE" });
        fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${baru}.json`, {
          method: "PUT",
          body: JSON.stringify(updated)
        }).then(() => loadData());
      }
    }

    function hapusForum(nama) {
      if (confirm(`Hapus forum "${nama}"?`)) {
        fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${nama}.json`, {
          method: "DELETE"
        }).then(() => loadData());
      }
    }

    loadData();
    updateRefreshInterval(); // start countdown
  </script>
</body>
</html>
