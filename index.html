<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SAFD MONEY</title>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  .section { margin-bottom: 30px; }
  input, button, textarea { margin: 5px 0; padding: 10px; width: 100%; }
  .chat-box { border: 1px solid #ccc; padding: 10px; max-height: 200px; overflow-y: scroll; }
  .message { margin-bottom: 10px; }
  #saldo { color: green; font-weight: bold; }
  #adminPanel { display:none; border: 1px solid #444; padding: 10px; background: #f9f9f9; }
  table { width: 100%; border-collapse: collapse; margin-top:10px; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
</style>
</head>
<body>
<h1>SAFD MONEY</h1>

<div class="section" id="accountSection">
  <h2>Buat Forum Anda</h2>
  <input type="text" id="namaDepan" placeholder="Nama Depan" />
  <input type="text" id="namaBelakang" placeholder="Nama Belakang" />
  <button id="buatAkunBtn">Buat Forum</button>
  <p id="infoPengguna"></p>
</div>

<div class="section" id="forumSection" style="display:none;">
  <h2>Forum Anda</h2>
  <p><strong>Saldo:</strong> <span id="saldo">Rp 0</span></p>
  <input type="number" id="jumlah" placeholder="Jumlah Uang" />
  <button id="tambahBtn">Tambah</button>
  <button id="ambilBtn">Ambil</button>
  <button id="setorBtn">Setor (Reset Saldo)</button>
  <div id="riwayat"></div>
</div>

<div class="section">
  <h2>Obrolan</h2>
  <div class="chat-box" id="chatBox"></div>
  <textarea id="pesan" placeholder="Ketik pesan Anda"></textarea>
  <button id="kirimBtn">Kirim</button>
</div>

<div class="section">
  <button id="btnAdminAccess">Panel Admin</button>
</div>

<div id="adminPanel">
  <h2>Panel Admin</h2>
  <p>
    <strong>Masukkan Password Admin:</strong>
    <input type="password" id="adminPass" placeholder="Password" />
    <button id="loginAdminBtn">Login</button>
  </p>
  <div id="adminContent" style="display:none;">
    <h3>Daftar Akun</h3>
    <table id="adminTable">
      <thead><tr><th>Nama</th><th>Saldo</th><th>Aksi</th></tr></thead>
      <tbody></tbody>
    </table>
    <h3>Top Tier (3 Teratas)</h3>
    <ol id="topTierList"></ol>
    <p>
      <label>Ubah Nama Admin: <input type="text" id="adminNameInput" value="Admin" /></label>
    </p>
    <button id="logoutAdminBtn">Logout Admin</button>
  </div>
</div>

<script>
  // Inisialisasi Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyA3-34rf9VZUIrAIR6z4BJtQm_MClqXm-Q",
    authDomain: "uangduty.firebaseapp.com",
    databaseURL: "https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "uangduty",
    storageBucket: "uangduty.appspot.com",
    messagingSenderId: "598905752132",
    appId: "1:598905752132:web:9b764840e51c13a3044a11",
    measurementId: "G-YXZPEVYBDR"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Variabel global
  let userKey = localStorage.getItem("userKey");
  let fullName = localStorage.getItem("fullName");
  let isAdmin = false;
  let adminName = "Admin";

  // Elemen HTML
  const accountSection = document.getElementById("accountSection");
  const forumSection = document.getElementById("forumSection");
  const infoPengguna = document.getElementById("infoPengguna");
  const saldoEl = document.getElementById("saldo");
  const riwayatEl = document.getElementById("riwayat");
  const chatBox = document.getElementById("chatBox");
  const pesanEl = document.getElementById("pesan");
  const adminPanel = document.getElementById("adminPanel");
  const adminPassEl = document.getElementById("adminPass");
  const adminContent = document.getElementById("adminContent");
  const adminTableBody = document.querySelector("#adminTable tbody");
  const topTierList = document.getElementById("topTierList");
  const adminNameInput = document.getElementById("adminNameInput");

  // Fungsi format rupiah
  function formatRupiah(angka) {
    if(!angka) return "Rp 0";
    return "Rp " + angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  // Tampilkan saldo
  function tampilkanSaldo(saldo) {
    saldoEl.innerText = formatRupiah(saldo);
  }

  // Update status tampilan akun atau forum
  function updateDisplay() {
    if(userKey && fullName) {
      accountSection.style.display = "none";
      forumSection.style.display = "block";
      infoPengguna.innerText = `Selamat datang, ${fullName}${isAdmin ? " (Admin: "+adminName+")" : ""}`;
      pantauSaldo();
      pantauRiwayat();
    } else {
      accountSection.style.display = "block";
      forumSection.style.display = "none";
      infoPengguna.innerText = "";
    }
  }

  // Pantau saldo realtime
  function pantauSaldo() {
    if (!userKey) return;
    db.ref(`forum/${userKey}/saldo`).on("value", snap => {
      tampilkanSaldo(snap.val());
    });
  }

  // Pantau riwayat realtime
  function pantauRiwayat() {
    if (!userKey) return;
    db.ref(`forum/${userKey}/riwayat`).on("value", snap => {
      const val = snap.val();
      riwayatEl.innerHTML = "<h4>Riwayat:</h4>";
      if(val) {
        Object.values(val).forEach(item => {
          const p = document.createElement("p");
          p.textContent = item;
          riwayatEl.appendChild(p);
        });
      }
    });
  }

  // Buat akun baru
  document.getElementById("buatAkunBtn").onclick = () => {
    const depan = document.getElementById("namaDepan").value.trim();
    const belakang = document.getElementById("namaBelakang").value.trim();
    if(!depan || !belakang) {
      alert("Nama depan dan belakang wajib diisi!");
      return;
    }
    const namaLengkap = depan + " " + belakang;
    // Simpan ke Firebase
    const newRef = db.ref("forum").push();
    newRef.set({
      nama: namaLengkap,
      saldo: 0,
      riwayat: {}
    }).then(() => {
      userKey = newRef.key;
      fullName = namaLengkap;
      localStorage.setItem("userKey", userKey);
      localStorage.setItem("fullName", fullName);
      updateDisplay();
      loadTopTier();
    });
  };

  // Fungsi tambah saldo
  document.getElementById("tambahBtn").onclick = () => {
    const jml = Number(document.getElementById("jumlah").value);
    if(!jml || jml <= 0) {
      alert("Masukkan jumlah uang valid!");
      return;
    }
    db.ref(`forum/${userKey}`).once("value").then(snap => {
      const data = snap.val();
      const saldoBaru = (data.saldo || 0) + jml;
      db.ref(`forum/${userKey}`).update({ saldo: saldoBaru });
      const waktu = new Date().toLocaleString();
      const riwayatBaru = (data.riwayat || {});
      riwayatBaru[waktu] = `Tambah ${formatRupiah(jml)}`;
      db.ref(`forum/${userKey}/riwayat`).set(riwayatBaru);
      document.getElementById("jumlah").value = "";
    });
  };

  // Fungsi ambil saldo
  document.getElementById("ambilBtn").onclick = () => {
    const jml = Number(document.getElementById("jumlah").value);
    if(!jml || jml <= 0) {
      alert("Masukkan jumlah uang valid!");
      return;
    }
    db.ref(`forum/${userKey}`).once("value").then(snap => {
