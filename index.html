<!DOCTYPE html><html>
<head>
  <title>UangDuty Panel</title>
  <style>
    body { font-family: Arial; background: #f2f2f2; margin: 20px; }
    .forum-btn { display: block; margin: 5px 0; padding: 10px; background: #fff; border: 1px solid #ccc; cursor: pointer; }
    .indicator { position: fixed; top: 10px; left: 10px; background: red; color: white; padding: 4px 10px; border-radius: 6px; }
    .loading { font-weight: bold; color: #555; }
  </style>
</head>
<body>
  <div id="indikator" class="indicator" style="display:none;">STAFF MODE</div>  <h2>Selamat datang di UangDuty Panel</h2>  <input type="text" id="username" placeholder="Masukkan nama Anda">
  <button onclick="setUser()">Masuk</button>  <hr><button onclick="aksesStaff()">Akses Staff SAFD</button> <button onclick="modeNormal()" id="normalModeBtn" style="display:none;">Mode Normal</button>

  <div id="tambahStaffWrap" style="display:none;">
    <input type="text" id="namaStaffBaru" placeholder="Nama Staff">
    <button onclick="tambahStaff()">Tambah Staff</button>
  </div>  <h3>Buat Forum</h3>
  <button onclick="buatForum()">Buat Forum Saya</button>  <h3>List Forum Umum</h3>
  <div id="listForumUmum"></div>  <h3>Forum Anda</h3>
  <div id="daftarForum"></div>  <script>
    let currentUser = localStorage.getItem('user') || '';
    let isStaff = localStorage.getItem('staffMode') === 'true';
    let daftarStaff = JSON.parse(localStorage.getItem('daftarStaff') || '[]');
    let forums = JSON.parse(localStorage.getItem('forums') || '[]');

    if (currentUser && !forums.find(f => f.pemilik === currentUser)) {
      localStorage.removeItem('user');
      currentUser = '';
    }

    if (isStaff) {
      document.getElementById('indikator').style.display = 'block';
      document.getElementById('normalModeBtn').style.display = 'inline';
      document.getElementById('tambahStaffWrap').style.display = 'block';
    }

    function simpanData() {
      localStorage.setItem('forums', JSON.stringify(forums));
    }

    function setUser() {
      const nama = document.getElementById('username').value.trim();
      if (!nama) return;
      if (!forums.find(f => f.pemilik === nama)) {
        alert("Forum belum dibuat. Silakan klik 'Buat Forum Saya'.");
        return;
      }
      currentUser = nama;
      localStorage.setItem('user', nama);
      tampilForum();
    }

    function aksesStaff() {
      const pass = prompt("Masukkan password staff:");
      if (pass === "RFD") {
        isStaff = true;
        localStorage.setItem('staffMode', 'true');
        document.getElementById('indikator').style.display = 'block';
        document.getElementById('normalModeBtn').style.display = 'inline';
        document.getElementById('tambahStaffWrap').style.display = 'block';
        tampilForum();
      } else {
        alert("Password salah!");
      }
    }

    function modeNormal() {
      isStaff = false;
      localStorage.removeItem('staffMode');
      document.getElementById('indikator').style.display = 'none';
      document.getElementById('normalModeBtn').style.display = 'none';
      document.getElementById('tambahStaffWrap').style.display = 'none';
      tampilForum();
    }

    function tambahStaff() {
      const nama = document.getElementById('namaStaffBaru').value.trim();
      if (!nama || daftarStaff.includes(nama)) return;
      daftarStaff.push(nama);
      localStorage.setItem('daftarStaff', JSON.stringify(daftarStaff));
      alert('Staff ditambahkan');
    }

    function buatForum() {
      if (currentUser) return alert("Anda sudah punya forum.");
      const nama = document.getElementById('username').value.trim();
      if (!nama) return;

      if (forums.find(f => f.pemilik === nama)) {
        alert("Forum sudah dibuat.");
        return;
      }

      const forum = {
        id: "forum_" + Date.now(),
        nama: nama + "'s Forum",
        pemilik: nama,
        total: 0,
        riwayat: [],
        akses: []
      };

      forums.push(forum);
      simpanData();
      localStorage.setItem('user', nama);
      currentUser = nama;
      tampilForum();
    }

    function tampilForum() {
      const daftar = document.getElementById('daftarForum');
      daftar.innerHTML = '<div class="loading">Memuat forum...</div>';

      setTimeout(() => {
        daftar.innerHTML = '';
        forums.forEach(f => {
          const bisaLihat = f.pemilik === currentUser || isStaff;
          if (!bisaLihat) return;

          const btn = document.createElement('button');
          btn.className = 'forum-btn';
          btn.innerText = f.nama;
          btn.onclick = () => bukaForum(f.id);
          daftar.appendChild(btn);

          if (isStaff) {
            const ubah = document.createElement('button');
            ubah.innerText = 'Ubah Nama';
            ubah.onclick = () => {
              const baru = prompt("Nama baru:", f.nama);
              if (baru) {
                f.nama = baru;
                simpanData();
                tampilForum();
              }
            };
            daftar.appendChild(ubah);

            const hapus = document.createElement('button');
            hapus.innerText = 'Hapus';
            hapus.onclick = () => {
              if (confirm("Yakin hapus forum?")) {
                forums = forums.filter(ff => ff.id !== f.id);
                simpanData();
                tampilForum();
              }
            };
            daftar.appendChild(hapus);
          }
        });
        tampilUmum();
      }, 500);
    }

    function tampilUmum() {
      const umum = document.getElementById('listForumUmum');
      umum.innerHTML = '';
      forums.forEach(f => {
        const item = document.createElement('div');
        item.innerText = f.pemilik;
        umum.appendChild(item);
      });
    }

    function bukaForum(id) {
      const win = window.open('', '_blank');
      const forum = forums.find(f => f.id === id);
      if (!forum) return;

      if (isStaff && currentUser !== forum.pemilik) {
        const waktu = new Date().toLocaleString();
        forum.riwayat.push("Staff " + currentUser + " melihat forum anda pada " + waktu);
        simpanData();
      }

      let html = `<h2>${forum.nama}</h2>`;
      html += `<h3>Total Uang: ${forum.total}</h3><ul>`;
      forum.riwayat.forEach(r => html += `<li>${r}</li>`);
      html += `</ul>`;

      if (!isStaff || currentUser === forum.pemilik) {
        html += `<button onclick="window.opener.tambahUang('${id}')">Tambah UangDuty</button>
                 <button onclick="window.opener.ambilUang('${id}')">Ambil UangDuty</button>
                 <button onclick="window.opener.setorUang('${id}')">Setor UangDuty</button>`;
      } else {
        html += `<p>Mode Staff - Tidak bisa mengedit forum.</p>`;
      }

      win.document.body.innerHTML = html;
    }

    function tambahUang(id) {
      const jumlah = parseInt(prompt("Jumlah: "));
      if (isNaN(jumlah)) return;
      const f = forums.find(f => f.id === id);
      f.total += jumlah;
      f.riwayat.push("Tambah " + jumlah);
      simpanData();
    }

    function ambilUang(id) {
      const jumlah = parseInt(prompt("Jumlah: "));
      if (isNaN(jumlah)) return;
      const f = forums.find(f => f.id === id);
      f.total -= jumlah;
      f.riwayat.push("Ambil " + jumlah);
      simpanData();
    }

    function setorUang(id) {
      const f = forums.find(f => f.id === id);
      f.riwayat.push("Setor " + f.total);
      f.total = 0;
      simpanData();
    }

    if (currentUser) tampilForum();
  </script></body>
</html>
