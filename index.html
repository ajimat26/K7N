<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SAFD MONEY Forum - Firebase Realtime</title>
<style>
  body { font-family: Arial, sans-serif; background: #eee; padding: 20px; margin: 0; }
  .panel { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  h2 { margin-top: 0; }
  .hidden { display: none; }
  input, button { margin-top: 5px; display: block; padding: 8px; width: 100%; max-width: 300px; }
  .chat-box { background: #f9f9f9; padding: 10px; height: 150px; overflow-y: auto; border: 1px solid #ccc; margin-top: 10px; }
  .green { color: green; font-weight: bold; }
  button { cursor: pointer; }
</style>
</head>
<body>

<div class="panel" id="buatAkunPanel">
  <h2>Buat Akun SAFD</h2>
  <input type="text" id="namaAkun" placeholder="Nama Akun"/>
  <input type="number" id="uangAkun" placeholder="Saldo Awal"/>
  <button onclick="buatAkun()">Buat Akun</button>
</div>

<div class="panel hidden" id="forumPanel">
  <h2>Forum SAFD MONEY</h2>
  <p>Selamat datang, <span id="namaPengguna"></span>! <button onclick="logout()">Logout</button></p>
  <p>Saldo: <span id="uangPengguna" class="green"></span></p>

  <input type="text" id="chatInput" placeholder="Tulis pesan..." onkeypress="if(event.key==='Enter'){kirimChat()}"/>
  <button onclick="kirimChat()">Kirim</button>

  <div class="chat-box" id="chatBox"></div>
  <button onclick="bukaAdminLogin()">Masuk Admin</button>
</div>

<div class="panel hidden" id="loginAdminPanel">
  <h2>Login Admin</h2>
  <input type="password" id="adminPassword" placeholder="Password Admin"/>
  <button onclick="loginAdmin()">Login</button>
  <button onclick="batalAdmin()">Batal</button>
</div>

<div class="panel hidden" id="adminPanel">
  <h2>Panel Admin</h2>
  <p>Nama Admin: <span id="namaAdminTampil"></span> <button onclick="keluarAdmin()">Keluar Admin</button></p>

  <input type="text" id="editNamaAdmin" placeholder="Ubah Nama Admin"/>
  <button onclick="ubahNamaAdmin()">Ubah Nama</button>

  <h3>Daftar Akun</h3>
  <ul id="daftarAkun"></ul>
</div>

<div class="panel">
  <h2>Top Tier Investor</h2>
  <ol id="topTierList"></ol>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
  // Ganti config ini dengan config Firebase projectmu
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTHDOMAIN",
    databaseURL: "YOUR_DATABASE_URL",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let akun = null;
  let isAdmin = false;
  let adminName = "Admin SAFD";

  // Simpan akun baru di Firebase
  function buatAkun() {
    const nama = document.getElementById("namaAkun").value.trim();
    const uang = parseInt(document.getElementById("uangAkun").value);
    if (!nama || isNaN(uang) || uang < 0) return alert("Isi nama dan saldo dengan benar!");

    // Cek apakah nama sudah ada
    db.ref("akun").orderByChild("nama").equalTo(nama).get().then(snapshot => {
      if(snapshot.exists()) {
        alert("Nama akun sudah digunakan!");
      } else {
        const akunBaru = { nama, uang };
        // Push ke Firebase (gunakan key generated otomatis)
        db.ref("akun").push(akunBaru).then(() => {
          loginAkun(nama);
        });
      }
    });
  }

  // Login akun biasa (bukan admin)
  function loginAkun(nama) {
    db.ref("akun").orderByChild("nama").equalTo(nama).limitToFirst(1).get().then(snapshot => {
      if(snapshot.exists()) {
        snapshot.forEach(child => {
          akun = { id: child.key, ...child.val() };
        });
        isAdmin = false;
        tampilkanForum();
        listenSaldo();
        listenChat();
        listenTopTier();
      } else {
        alert("Akun tidak ditemukan");
      }
    });
  }

  // Update saldo realtime listener
  function listenSaldo() {
    if (!akun) return;
    db.ref("akun/" + akun.id + "/uang").on("value", (snap) => {
      if (snap.exists()) {
        akun.uang = snap.val();
        document.getElementById("uangPengguna").textContent = `Rp ${akun.uang.toLocaleString()}`;
      }
    });
  }

  // Kirim chat ke Firebase
  function kirimChat() {
    if (!akun) return alert("Belum login");
    const pesan = document.getElementById("chatInput").value.trim();
    if (!pesan) return;
    const chatData = {
      nama: akun.nama,
      pesan,
      waktu: Date.now()
    };
    db.ref("chat").push(chatData);
    document.getElementById("chatInput").value = "";
  }

  // Dengar chat realtime dan tampilkan
  function listenChat() {
    const chatBox = document.getElementById("chatBox");
    chatBox.innerHTML = "";
    db.ref("chat").limitToLast(50).on("child_added", (snap) => {
      const data = snap.val();
      const p = document.createElement("p");
      p.innerHTML = `<b>${data.nama}:</b> ${data.pesan}`;
      chatBox.appendChild(p);
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  }

  // Tampilkan forum, sembunyikan buat akun dan admin login
  function tampilkanForum() {
    document.getElementById("buatAkunPanel").classList.add("hidden");
    document.getElementById("loginAdminPanel").classList.add("hidden");
    document.getElementById("adminPanel").classList.add("hidden");
    document.getElementById("forumPanel").classList.remove("hidden");
    document.getElementById("namaPengguna").textContent = akun.nama;
    document.getElementById("uangPengguna").textContent = `Rp ${akun.uang.toLocaleString()}`;
  }

  // Logout akun (biasa)
  function logout() {
    akun = null;
    isAdmin = false;
    document.getElementById("forumPanel").classList.add("hidden");
    document.getElementById("adminPanel").classList.add("hidden");
    document.getElementById("buatAkunPanel").classList.remove("hidden");
    // Hentikan listener Firebase
    db.ref("akun").off();
    db.ref("chat").off();
    db.ref("akun").off();
    db.ref("akun").off();
  }

  // Buka panel login admin
  function bukaAdminLogin() {
    if (!akun) return alert("Harus login dulu!");
    document.getElementById("loginAdminPanel").classList.remove("hidden");
    document.getElementById("forumPanel").classList.add("hidden");
  }

  // Batalkan login admin, kembali ke forum
  function batalAdmin() {
    document.getElementById("loginAdminPanel").classList.add("hidden");
    document.getElementById("forumPanel").classList.remove("hidden");
  }

  // Login admin
  function loginAdmin() {
    const pass = document.getElementById("adminPassword").value;
    if (pass !== "RFD1") return alert("Password admin salah!");
    isAdmin = true;
    adminName = akun.nama + " (Admin)";
    document.getElementById("namaAdminTampil").textContent = adminName;
    document.getElementById("loginAdminPanel").classList.add("hidden");
    document.getElementById("adminPanel").classList.remove("hidden");
    tampilkanDaftarAkun();
    document.getElementById("namaPengguna").textContent = adminName;
  }

  // Keluar mode admin, kembali ke mode biasa
  function keluarAdmin() {
    isAdmin = false;
    document.getElementById("adminPanel").classList.add("hidden");
    document.getElementById("forumPanel").classList.remove("hidden");
    document.getElementById("namaPengguna").textContent = akun.nama;
  }

  // Ubah nama admin (hanya ubah tampilan)
  function ubahNamaAdmin() {
    const namaBaru = document.getElementById("editNamaAdmin").value.trim();
    if (!namaBaru) return alert("Nama admin tidak boleh kosong");
    adminName = namaBaru;
    document.getElementById("namaAdminTampil").textContent = adminName;
    document.getElementById("namaPengguna").textContent = adminName;
  }

  // Tampilkan daftar akun di admin panel
  function tampilkanDaftarAkun() {
    const ul = document.getElementById("daftarAkun");
    ul.innerHTML = "";
    db.ref("akun").once("value").then(snapshot => {
      snapshot.forEach(child => {
        const data = child.val();
        const li = document.createElement("li");
        li.innerHTML = `
          ${data.nama} - <span class="green">Rp ${data.uang.toLocaleString()}</span>
          <button onclick="gantiNama('${child.key}')">Ganti Nama</button>
          <button onclick="hapusAkun('${child.key}')">Hapus</button>
          <button onclick="tambahUang('${child.key}')">Tambah Uang</button>
          <button onclick="ambilUang('${child.key}')">Ambil Uang</button>
        `;
        ul.appendChild(li);
      });
    });
  }

  // Ganti nama akun di Firebase
  function gantiNama(id) {
    const namaBaru = prompt("Nama baru:");
    if (!namaBaru) return;
    db.ref("akun/" + id + "/nama").set(namaBaru).then(() => {
