<!DOCTYPE html><html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UANGDUTY</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .section { margin-bottom: 30px; }
    input, button, textarea { margin: 5px 0; padding: 10px; width: 100%; }
    .chat-box { border: 1px solid #ccc; padding: 10px; max-height: 200px; overflow-y: scroll; }
    .message { margin-bottom: 10px; }
    .right { text-align: right; }
    #adminBtn { position: absolute; top: 10px; left: 10px; background-color: green; color: white; padding: 5px 10px; border: none; }
    #adminIndicator { color: green; font-weight: bold; }
  </style>
</head>
<body>
  <button id="adminBtn" onclick="modeAdmin()">Mode Admin</button>
  <h1>UANGDUTY</h1>
  <div id="adminIndicator"></div>
  <div class="section" id="buatAkunSection">
    <h2>Akun Anda</h2>
    <input type="text" id="namaDepan" placeholder="Nama Depan">
    <input type="text" id="namaBelakang" placeholder="Nama Belakang">
    <button onclick="buatAkun()">Buat Forum Anda</button>
    <p id="infoPengguna"></p>
  </div>
  <div class="section" id="forumSection" style="display:none">
    <h2>Forum Anda</h2>
    <p><strong>Saldo:</strong> <span id="saldo" style="color:green">0</span> Rupiah</p>
    <input type="number" id="jumlah" placeholder="Jumlah Uang">
    <button onclick="tambahUang()">Tambah</button>
    <button onclick="ambilUang()">Ambil</button>
    <button onclick="setorUang()">Setor (Reset)</button>
    <div id="riwayat"></div>
  </div>
  <div class="section">
    <h2>Obrolan</h2>
    <div class="chat-box" id="chatBox"></div>
    <textarea id="pesan" placeholder="Ketik pesan Anda"></textarea>
    <button onclick="kirimPesan()">Kirim</button>
  </div>
  <div class="section" id="adminSection" style="display:none">
    <h2>Data Semua Pegawai</h2>
    <div id="listPegawai"></div>
    <button onclick="toggleFormAkun()" id="toggleFormBtn">Tutup Form Buat Akun</button>
  </div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA3-34rf9VZUIrAIR6z4BJtQm_MClqXm-Q",
      authDomain: "uangduty.firebaseapp.com",
      databaseURL: "https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "uangduty",
      storageBucket: "uangduty.appspot.com",
      messagingSenderId: "598905752132",
      appId: "1:598905752132:web:9b764840e51c13a3044a11",
      measurementId: "G-YXZPEVYBDR"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();let userKey = localStorage.getItem("userKey");
let fullName = localStorage.getItem("fullName");
let isAdmin = false;
let formAkunTerbuka = true;

if (userKey && fullName) {
  document.getElementById("infoPengguna").innerText = `Selamat datang, ${fullName}`;
  document.getElementById("forumSection").style.display = "block";
  pantauSaldo();
  pantauRiwayat();
}

function buatAkun() {
  const depan = document.getElementById("namaDepan").value;
  const belakang = document.getElementById("namaBelakang").value;
  const nama = `${depan} ${belakang}`;

  if (!formAkunTerbuka) return alert("Form akun sedang ditutup oleh admin.");
  if (!depan || !belakang) return alert("Lengkapi nama Anda.");
  if (userKey) return;

  const ref = db.ref("forum").push();
  ref.set({ nama, saldo: 0 });
  userKey = ref.key;
  localStorage.setItem("userKey", userKey);
  localStorage.setItem("fullName", nama);
  location.reload();
}

function pantauSaldo() {
  db.ref(`forum/${userKey}/saldo`).on("value", snap => {
    const val = snap.val();
    document.getElementById("saldo").innerText = formatRupiah(val);
  });
}

function pantauRiwayat() {
  db.ref(`forum/${userKey}/riwayat`).on("value", snap => {
    const riw = snap.val();
    const el = document.getElementById("riwayat");
    el.innerHTML = "<h4>Riwayat:</h4>";
    const riwKeys = Object.keys(riw || {}).slice(-5);
    riwKeys.forEach(key => {
      el.innerHTML += `<p>${riw[key]}</p>`;
    });
  });
}

function tambahUang() { ubahSaldo("tambah"); }
function ambilUang() { ubahSaldo("ambil"); }
function setorUang() {
  db.ref(`forum/${userKey}`).update({ saldo: 0 });
  tambahRiwayat("Setor semua saldo ke 0");
}

function ubahSaldo(tipe) {
  const jumlah = parseInt(document.getElementById("jumlah").value);
  if (isNaN(jumlah) || jumlah <= 0) return alert("Masukkan jumlah valid.");
  const saldoRef = db.ref(`forum/${userKey}/saldo`);
  saldoRef.once("value").then(snap => {
    let saldo = snap.val() || 0;
    if (tipe === "tambah") saldo += jumlah;
    if (tipe === "ambil") saldo -= jumlah;
    saldoRef.set(saldo);
    tambahRiwayat(`${tipe === "tambah" ? "Tambah" : "Ambil"} ${formatRupiah(jumlah)}`);
  });
}

function tambahRiwayat(teks) {
  const riwRef = db.ref(`forum/${userKey}/riwayat`);
  riwRef.once("value", snap => {
    const data = snap.val() || {};
    const keys = Object.keys(data);
    if (keys.length >= 5) riwRef.child(keys[0]).remove();
    riwRef.push(teks);
  });
}

db.ref("chat").on("child_added", snap => {
  const { nama, pesan } = snap.val();
  const div = document.createElement("div");
  div.className = "message" + (nama === fullName ? " right" : "");
  div.innerText = `${nama}: ${pesan}`;
  document.getElementById("chatBox").appendChild(div);
  document.getElementById("chatBox").scrollTop = 99999;
});

function kirimPesan() {
  const teks = document.getElementById("pesan").value;
  if (!teks || !fullName) return;
  db.ref("chat").push({ nama: fullName, pesan: teks });
  document.getElementById("pesan").value = "";
}

function modeAdmin() {
  const pass = prompt("Masukkan password admin:");
  if (pass === "RFD") {
    isAdmin = true;
    document.getElementById("adminSection").style.display = "block";
    document.getElementById("adminIndicator").innerText = "Mode Admin Aktif";
    tampilkanSemuaForum();
  }
}

function tampilkanSemuaForum() {
  db.ref("forum").once("value", snap => {
    const data = snap.val();
    const div = document.getElementById("listPegawai");
    div.innerHTML = "";
    for (let key in data) {
      div.innerHTML += `<p><strong>${data[key].nama}</strong> - Saldo: ${formatRupiah(data[key].saldo)}</p>`;
    }
  });
}

function toggleFormAkun() {
  formAkunTerbuka = !formAkunTerbuka;
  document.getElementById("toggleFormBtn").innerText = formAkunTerbuka ? "Tutup Form Buat Akun" : "Buka Form Buat Akun";
}

function formatRupiah(angka) {
  return new Intl.NumberFormat('id-ID').format(angka) + 'rb';
}

  </script>
</body>
  </html>
