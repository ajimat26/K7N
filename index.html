<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>UangDuty Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; margin: 10px; background: #f4f4f4; }
    h1 { color: #333; font-size: 20px; }
    .card {
      background: white; padding: 15px; margin-bottom: 10px;
      border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: relative;
    }
    .total { font-weight: bold; color: green; }
    .riwayat, .opsi-menu { display: none; margin-top: 10px; font-size: 14px; color: #444; }
    .button { padding: 6px 10px; background: #007bff; color: white; border: none; border-radius: 5px; margin-top: 8px; font-size: 12px; }
    .menu-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 18px; }
    .tag-juara { font-size: 12px; color: white; background: #007bff; padding: 3px 6px; border-radius: 5px; margin-left: 6px; }
    .running-text {
      background: black; color: white; padding: 8px; overflow: hidden; white-space: nowrap;
    }
    .running-text span {
      display: inline-block; padding-left: 100%; animation: scroll 140s linear infinite;
      color: white;
    }
    @keyframes scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
  </style>
</head>
<body>
  <h1>ðŸ“Š Uang Duty SAFD</h1>
  <div class="running-text"><span id="running"></span></div>
  <div id="data-container">Memuat data...</div>

  <script>
    let pauseUpdate = false;

    function formatRupiah(angka) {
      return 'Rp. ' + angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function refreshData() {
      if (pauseUpdate) return;
      fetch("https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data.json")
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById("data-container");
          container.innerHTML = "";

          const list = Object.entries(data || {}).map(([nama, val]) => {
            return { nama: val.nama || nama, uang: val.uang || 0, riwayat: val.riwayat || [], lastUpdate: val.lastUpdate || "" };
          });

          // Sort uang terbesar ke terkecil
          list.sort((a, b) => b.uang - a.uang);

          // Tambah tag juara
          list.forEach((item, i) => {
            if (i === 0) item.tag = "Juara 1";
            else if (i === 1) item.tag = "Juara 2";
            else if (i === 2) item.tag = "Juara 3";
          });

          // Isi running text
          const riwayats = list.flatMap(p => p.riwayat.map(r => `${p.nama}: ${r}`));
          document.getElementById("running").innerText = riwayats.slice(-5).join(" â€¢ ");

          for (const pemain of list) {
            const div = document.createElement("div");
            div.className = "card";
            const total = formatRupiah(pemain.uang);
            const tag = pemain.tag ? `<span class="tag-juara">${pemain.tag}</span>` : "";

            div.innerHTML = `<strong>ðŸ“› ${pemain.nama}</strong> ${tag}<br>
                             <span class="total">Total Uang: ${total}</span><br>
                             <small>ðŸ•’ Terakhir diperbarui: ${pemain.lastUpdate || "Tidak tersedia"}</small><br>
                             <button class="button riwayat-btn">Lihat Riwayat</button>
                             <button class="button opsi-btn">â‹®</button>
                             <div class="riwayat">${pemain.riwayat.length > 0 ? pemain.riwayat.map(r => "â€¢ " + r).join("<br>") : "Tidak ada riwayat"}<br><button class="button close-riwayat">Tutup Riwayat</button></div>
                             <div class="opsi-menu">
                               <button class="button">Ubah Nama</button>
                               <button class="button">Hapus</button>
                             </div>`;

            // Tombol Lihat Riwayat
            div.querySelector(".riwayat-btn").addEventListener("click", () => {
              pauseUpdate = true;
              div.querySelector(".riwayat").style.display = "block";
            });

            // Tombol Tutup Riwayat
            div.querySelector(".close-riwayat").addEventListener("click", () => {
              div.querySelector(".riwayat").style.display = "none";
              pauseUpdate = false;
            });

            // Tombol titik tiga
            div.querySelector(".opsi-btn").addEventListener("click", () => {
              pauseUpdate = true;
              div.querySelector(".opsi-menu").style.display = "block";
            });

            // Tutup opsi jika klik luar
            document.addEventListener("click", function handler(e) {
              if (!div.contains(e.target)) {
                div.querySelector(".opsi-menu").style.display = "none";
                pauseUpdate = false;
                document.removeEventListener("click", handler);
              }
            });

            container.appendChild(div);
          }
        })
        .catch(err => {
          document.getElementById("data-container").innerText = "Gagal memuat data.";
          console.error(err);
        });
    }

    setInterval(refreshData, 1000); // real-time setiap 1 detik
    refreshData();
  </script>
</body>
</html>
