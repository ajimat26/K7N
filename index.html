<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UANGDUTY</title>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  #adminPanel { border: 1px solid #4CAF50; padding: 10px; margin-bottom: 20px; background-color: #e8f5e9; display: none; }
  #adminToggle {
    position: fixed;
    top: 10px; left: 10px;
    background-color: #f44336; /* default merah */
    color: white;
    border: none; padding: 8px 12px;
    cursor: pointer; border-radius: 4px;
    font-weight: bold;
    z-index: 1000;
  }
  #adminToggle.active {
    background-color: #4CAF50; /* hijau kalau aktif */
  }
  #adminStatus {
    position: fixed;
    top: 45px; left: 10px;
    font-weight: bold;
    color: red; /* default merah */
    display: block;
    z-index: 1000;
  }
  #adminStatus.active {
    color: green;
  }
  .section { margin-bottom: 30px; }
  input, button, textarea { margin: 5px 0; padding: 10px; width: 100%; box-sizing: border-box; }
  .chat-box { border: 1px solid #ccc; padding: 10px; max-height: 200px; overflow-y: auto; background: #f9f9f9; }
  .message { margin-bottom: 10px; }
  .right { text-align: right; }
  #saldo { color: green; font-weight: bold; }
  #riwayat p { margin: 0 0 5px 0; }
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #ddd; padding: 8px; }
  th { background-color: #4CAF50; color: white; }
  input.edit-nama { width: 90%; }
  button.hapus-btn { background-color: #f44336; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; }
</style>
</head>
<body>

<button id="adminToggle">Mode Admin</button>
<div id="adminStatus">Mode Admin Nonaktif</div>

<h1>UANGDUTY</h1>

<div id="adminPanel">
  <h3>Panel Admin</h3>
  <label>
    <input type="checkbox" id="toggleCreateAccount" />
    Aktifkan pembuatan akun untuk anggota
  </label>
  <h4>Data Anggota Forum</h4>
  <table id="dataAnggotaTable">
    <thead>
      <tr><th>Nama</th><th>Saldo</th><th>Aksi</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="section" id="createAccountSection">
  <h2>Buat Forum Anda</h2>
  <input type="text" id="namaDepan" placeholder="Nama Depan" />
  <input type="text" id="namaBelakang" placeholder="Nama Belakang" />
  <button id="btnBuatAkun">Buat Akun</button>
  <p id="infoPengguna"></p>
  <p id="infoCreateStatus" style="color:red; font-weight:bold;"></p>
</div>

<div class="section" id="forumSection" style="display:none;">
  <h2>Forum Anda</h2>
  <p><strong>Saldo:</strong> <span id="saldo">0</span> Rupiah</p>
  <input type="number" id="jumlah" placeholder="Jumlah Uang" />
  <button id="btnTambahUang">Tambah Uang</button>
  <button id="btnAmbilUang">Ambil Uang</button>
  <button id="btnSetorUang">Setor (Reset Saldo)</button>
  <div id="riwayat"></div>
</div>

<div class="section">
  <h2>Obrolan</h2>
  <div class="chat-box" id="chatBox"></div>
  <textarea id="pesan" placeholder="Ketik pesan Anda"></textarea>
  <button id="btnKirimPesan">Kirim</button>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyA3-34rf9VZUIrAIR6z4BJtQm_MClqXm-Q",
    authDomain: "uangduty.firebaseapp.com",
    databaseURL: "https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "uangduty",
    storageBucket: "uangduty.appspot.com",
    messagingSenderId: "598905752132",
    appId: "1:598905752132:web:9b764840e51c13a3044a11",
    measurementId: "G-YXZPEVYBDR"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const adminToggleBtn = document.getElementById('adminToggle');
  const adminStatus = document.getElementById('adminStatus');
  const adminPanel = document.getElementById('adminPanel');
  const toggleCreateAccount = document.getElementById('toggleCreateAccount');
  const createAccountSection = document.getElementById('createAccountSection');
  const dataAnggotaTableBody = document.querySelector('#dataAnggotaTable tbody');
  const infoCreateStatus = document.getElementById('infoCreateStatus');

  const btnBuatAkun = document.getElementById("btnBuatAkun");
  const btnTambahUang = document.getElementById("btnTambahUang");
  const btnAmbilUang = document.getElementById("btnAmbilUang");
  const btnSetorUang = document.getElementById("btnSetorUang");
  const btnKirimPesan = document.getElementById("btnKirimPesan");

  let userKey = localStorage.getItem("userKey");
  let fullName = localStorage.getItem("fullName");
  let isAdmin = false;
  let createAccountEnabled = true;

  // Ambil status create account dari DB
  db.ref("settings/createAccountEnabled").on("value", snap => {
    if (snap.exists()) {
      createAccountEnabled = snap.val();
      toggleCreateAccount.checked = createAccountEnabled;
      updateCreateAccountSection();
    }
  });

  function updateCreateAccountSection() {
    if (!createAccountEnabled) {
      createAccountSection.style.display = "none";
      if (!userKey) {
        infoCreateStatus.innerText = "Pembuatan akun saat ini DITUTUP oleh admin.";
      }
    } else {
      if (!userKey) {
        createAccountSection.style.display = "block";
        infoCreateStatus.innerText = "";
      }
    }
  }

  // Refresh tampilan user dan data saldo
  function refreshUserData() {
    if (userKey && fullName) {
      document.getElementById("infoPengguna").innerText = `Selamat datang, ${fullName}`;
      document.getElementById("forumSection").style.display = "block";
      createAccountSection.style.display = "none";
      pantauSaldo();
      pantauRiwayat();
    } else {
      document.getElementById("forumSection").style.display = "none";
      updateCreateAccountSection();
    }
  }

  // Toggle Mode Admin
  adminToggleBtn.addEventListener("click", () => {
    if (!isAdmin) {
      const pwd = prompt("Masukkan password admin:");
      if (pwd === "RFD1") {
        isAdmin = true;
        adminToggleBtn.classList.add("active");
        adminStatus.classList.add("active");
        adminStatus.textContent = "Mode Admin Aktif";
        adminPanel.style.display = "block";
        loadAdminData();
      } else {
        alert("Password salah!");
      }
    } else {
      isAdmin = false;
      adminToggleBtn.classList.remove("active");
      adminStatus.classList.remove("active");
      adminStatus.textContent = "Mode Admin Nonaktif";
      adminPanel.style.display = "none";
    }
  });

  // Admin toggle create account enable/disable
