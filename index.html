<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>UangDuty Viewer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 15px;
      overflow-x: hidden;
    }
    h1 {
      color: #333;
      font-size: 20px;
    }
    .card {
      background: white;
      padding: 15px;
      margin-bottom: 12px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: all 0.2s;
    }
    .riwayat {
      display: none;
      margin-top: 10px;
      font-size: 14px;
      color: #555;
    }
    .total {
      font-weight: bold;
      color: green;
    }
    .toolbar {
      margin-bottom: 10px;
      font-size: 14px;
    }
    #marquee-container {
      overflow-x: auto;
      white-space: nowrap;
      background: black;
      color: white;
      padding: 8px;
      margin: 10px 0;
      border-radius: 5px;
      font-size: 13px;
    }
    .tombol {
      background: #007BFF;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      margin-top: 6px;
    }
    .opsi {
      float: right;
      margin-top: -25px;
    }
    .opsi button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
    }
    .tag {
      background: gold;
      color: black;
      font-size: 10px;
      padding: 2px 5px;
      border-radius: 4px;
      margin-left: 5px;
    }
    .updated {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <h1>üìä Daftar Uang Duty</h1>
  <div class="toolbar">
    ‚è≥ Refresh dalam <span id="cooldown">60</span> detik
    | Auto Refresh: 
    <select id="refresh-setting">
      <option value="0">Mati</option>
      <option value="60">1m</option>
      <option value="120">2m</option>
      <option value="180">3m</option>
      <option value="240">4m</option>
      <option value="300">5m</option>
    </select>
  </div>

  <div id="marquee-container">Memuat riwayat...</div>
  <div id="data-container">Memuat data...</div>

  <script>
    let interval = 60, countdown = interval, pause = false;
    let autoRefresh, timeout;
    const refreshSelect = document.getElementById("refresh-setting");
    const cooldownText = document.getElementById("cooldown");

    function formatRupiah(angka) {
      return 'Rp. ' + (angka || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function updateCountdown() {
      if (!pause && interval > 0) {
        countdown--;
        cooldownText.textContent = countdown;
        if (countdown <= 0) {
          fetchData();
          countdown = interval;
        }
      }
    }

    refreshSelect.addEventListener("change", () => {
      interval = parseInt(refreshSelect.value);
      countdown = interval;
    });

    function createCard(nama, data, tag) {
      const div = document.createElement("div");
      div.className = "card";

      const total = formatRupiah(data.uang);
      let html = `<strong>üìõ ${data.nama}</strong> ${tag}
                  <div class="opsi">
                    <button onclick="showOptions('${nama}')">‚ãÆ</button>
                  </div><br>
                  <span class="total">Total Uang: ${total}</span>
                  <br><button class="tombol" onclick="toggleRiwayat(this)">üìú Lihat Riwayat</button>
                  <div class="riwayat">
                    <br><u>üìú Riwayat:</u><br>
                    ${data.riwayat && data.riwayat.length > 0 ? data.riwayat.map(r => "‚Ä¢ " + r).join("<br>") : "Tidak ada riwayat"}
                  </div>
                  <div class="updated">üïí Terakhir update: ${new Date(data.terakhir || Date.now()).toLocaleString()}</div>`;
      div.innerHTML = html;
      return div;
    }

    function toggleRiwayat(btn) {
      const r = btn.parentNode.querySelector(".riwayat");
      pause = true;
      r.style.display = r.style.display === "none" ? "block" : "none";
      btn.textContent = r.style.display === "none" ? "üìú Lihat Riwayat" : "üìú Lihat Riwayat";
      pause = r.style.display === "block";
    }

    function showOptions(nama) {
      pause = true;
      const opt = confirm(`üîß Ubah nama atau hapus forum ${nama}?\n\n‚úÖ OK = Ubah Nama\n‚ùå Cancel = Hapus`);
      if (opt) {
        const baru = prompt("Masukkan nama baru:", nama);
        if (baru && baru !== nama) {
          fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${nama}.json`)
            .then(res => res.json())
            .then(data => {
              fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${baru}.json`, {
                method: "PUT",
                body: JSON.stringify(data)
              });
              fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${nama}.json`, {
                method: "DELETE"
              }).then(() => fetchData());
            });
        }
      } else {
        const ya = confirm(`Yakin ingin menghapus forum ${nama}?`);
        if (ya) {
          fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${nama}.json`, {
            method: "DELETE"
          }).then(() => fetchData());
        }
      }
      pause = false;
    }

    function fetchData() {
      fetch("https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data.json")
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById("data-container");
          container.innerHTML = "";

          let dataArray = Object.entries(data || {}).map(([k, v]) => {
            return {nama: k, data: v};
          });

          dataArray.sort((a, b) => (b.data.uang || 0) - (a.data.uang || 0));

          let riwayatGabung = [];

          dataArray.forEach((item, idx) => {
            const tag = idx === 0 ? `<span class="tag">ü•á</span>` : idx === 1 ? `<span class="tag">ü•à</span>` : idx === 2 ? `<span class="tag">ü•â</span>` : "";
            container.appendChild(createCard(item.nama, item.data, tag));
            if (item.data.riwayat) {
              item.data.riwayat.forEach(r => riwayatGabung.push(`${item.data.nama}: ${r}`));
            }
          });

          document.getElementById("marquee-container").textContent = "üì∞ " + riwayatGabung.reverse().slice(0, 20).join(" ‚ö´ ");
        });
    }

    setInterval(updateCountdown, 1000);
    fetchData();
  </script>
</body>
  </html>
