<!DOCTYPE html>
<html>
<head>
  <title>UANGDUTY</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    h1 {
      margin-bottom: 10px;
    }
    #adminStatus {
      font-size: 12px;
      color: white;
      background: red;
      padding: 2px 6px;
      border-radius: 4px;
      display: inline-block;
    }
    #adminControls {
      display: none;
      margin-top: 10px;
    }
    button {
      margin: 5px;
      padding: 6px 12px;
    }
    .hidden {
      display: none;
    }
    #chatBox {
      width: 100%;
      height: 150px;
      border: 1px solid #ccc;
      overflow-y: scroll;
      background: white;
      padding: 10px;
    }
    #formSection, #userPanel, #adminPanel {
      margin-top: 20px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script>
    // Ganti dengan konfigurasi Firebase Anda
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>
</head>
<body>

<h1>UANGDUTY</h1>
<div id="adminSection">
  <button onclick="enterAdminMode()" style="background: green; color: white;">Mode Admin</button>
  <span id="adminStatus">Admin: Nonaktif</span>
</div>

<div id="adminControls">
  <label><input type="checkbox" id="toggleRegister" onchange="toggleRegistration()"> Izinkan Pembuatan Akun</label>
</div>

<div id="formSection">
  <h2>Form Akun</h2>
  <input id="username" placeholder="Nama akun">
  <button onclick="createAccount()">Buat Akun</button>
</div>

<div id="userPanel" class="hidden">
  <h2>Selamat datang, <span id="userName"></span></h2>
  <p>Saldo: <span id="userMoney" style="color: green;">Rp0</span></p>

  <input id="amount" type="number" placeholder="Jumlah uang">
  <button onclick="addMoney()">Tambah Uang</button>
  <button onclick="withdrawMoney()">Ambil Uang</button>
  <button onclick="resetMoney()">Setor (Reset)</button>

  <h3>Riwayat (maks. 5)</h3>
  <ul id="historyList"></ul>
</div>

<div id="chatSection">
  <h2>Obrolan</h2>
  <div id="chatBox"></div>
  <input id="chatInput" placeholder="Ketik pesan">
  <button onclick="sendChat()">Kirim</button>
</div>

<div id="adminPanel" class="hidden">
  <h2>Panel Admin: Data Semua Akun</h2>
  <ul id="allAccounts"></ul>
</div>

<script>
let account = null;
let isAdmin = false;
let allowRegister = true;

// Mendengarkan perubahan pada pengaturan pendaftaran
db.ref("settings/allowRegister").on("value", snap => {
  allowRegister = snap.val() !== false;
  document.getElementById("toggleRegister").checked = allowRegister;
});

function createAccount() {
  const name = document.getElementById("username").value.trim();
  if (!allowRegister) return alert("Pembuatan akun sedang ditutup admin.");
  if (!name) return alert("Nama tidak boleh kosong");
  if (account) return alert("Akun sudah dibuat.");

  const userRef = db.ref("accounts/" + name);
  userRef.once("value", snap => {
    if (snap.exists()) return alert("Nama sudah dipakai.");
    userRef.set({ money: 0, history: [] });
    login(name);
  });
}

function login(name) {
  account = name;
  document.getElementById("formSection").classList.add("hidden");
  document.getElementById("userPanel").classList.remove("hidden");
  document.getElementById("userName").textContent = account;
  db.ref("accounts/" + account).on("value", snap => {
    const data = snap.val();
    if (!data) return;
    document.getElementById("userMoney").textContent = "Rp" + formatMoney(data.money);
    const list = document.getElementById("historyList");
    list.innerHTML = "";
    (data.history || []).slice(-5).forEach(item => {
      const li = document.createElement("li");
      li.textContent = item;
      list.appendChild(li);
    });
  });
}

function addMoney() {
  const amount = parseInt(document.getElementById("amount").value);
  if (isNaN(amount) || amount <= 0) return;
  const userRef = db.ref("accounts/" + account);
  userRef.once("value", snap => {
    const data = snap.val();
    const newMoney = (data.money || 0) + amount;
    const history = (data.history || []).concat("Tambah Rp" + formatMoney(amount)).slice(-5);
    userRef.update({ money: newMoney, history });
  });
}

function withdrawMoney() {
  const amount = parseInt(document.getElementById("amount").value);
  if (isNaN(amount) || amount <= 0) return;
  const userRef = db.ref("accounts/" + account);
  userRef.once("value", snap => {
    const data = snap.val();
    if ((data.money || 0) < amount) return;
    const newMoney = data.money - amount;
    const history = (data.history || []).concat("Ambil Rp" + formatMoney(amount)).slice(-5);
    userRef.update({ money: newMoney, history });
  });
}

function resetMoney() {
  const userRef = db.ref("accounts/" + account);
  userRef.once("value", snap => {
    const history = (snap.val().history || []).concat("Setor (reset) saldo").slice(-5);
    userRef.update({ money: 0, history });
  });
}

function formatMoney(n) {
  return n.toLocaleString('id-ID') + "rb";
}

function sendChat() {
  const msg = document.getElementById("chatInput").value.trim();
  if (!msg || !account) return;
  db.ref("chatLog").push(account + ": " + msg);
  document.getElementById("chatInput").value = "";
}

function renderChat() {
  const box = document.getElementById("chatBox");
  db.ref("chatLog").on("value", snap => {
    const val = snap.val() || {};
    box.innerHTML = Object.values(val).map(m => `<div>${m}</div>`).join('');
    box.scrollTop = box.scrollHeight;
  });
}

function enterAdminMode() {
  const pass = prompt("Masukkan password admin:");
  if (pass === "RFD1") {
    isAdmin = true;
    document.getElementById("adminStatus").textContent = "Admin: Aktif";
    document.getElementById("adminStatus").style.background = "green";
    document.getElementById("adminControls").style.display = "block";
    document.getElementById("adminPanel").classList.remove("hidden");
    renderAdmin();
  } else {
    alert("Password salah.");
  }
}

function toggleRegistration() {
  const status = document.getElementById("toggleRegister").checked;
  db.ref("settings/allowRegister").set(status);
}

function renderAdmin() {
  const panel = document.getElementById("allAccounts");
  panel.innerHTML = "";
  db.ref("accounts").once("value", snap => {
    const data = snap.val() || {};
    for (const name in data) {
      const li = document.createElement("li");
      li.textContent = `${name} - Rp${formatMoney(data[name].money)} `;
      const renameBtn = document.createElement("button");
      renameBtn.textContent = "Ubah Nama";
      renameBtn.onclick = () => {
        const newName = prompt("Masukkan nama baru:");
        if (newName && !data[newName]) {
          db.ref("accounts/" + newName).set(data[name]);
          db.ref("accounts/" + name).remove();
          renderAdmin();
        }
      };
      const delBtn = document.createElement("button");
      delBtn.textContent = "Hapus";
      delBtn.onclick = () => {
        db.ref("accounts/" + name).remove0
