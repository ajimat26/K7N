<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Game Kotak Hadiah - Real Time & Admin</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: linear-gradient(to right, #fbc7a4, #f48fb1);
    margin: 0; padding: 20px;
    text-align: center;
  }
  h1 {
    color: #fff;
    background-color: #e91e63;
    padding: 15px;
    border-radius: 10px;
  }
  #box {
    width: 150px; height: 150px;
    margin: 20px auto;
    background-color: #ffcc80;
    border-radius: 15px;
    box-shadow: 0 0 15px #fb8c00;
    line-height: 150px;
    font-size: 40px;
    color: #6d4c41;
    user-select: none;
    cursor: pointer;
  }
  button {
    margin: 10px 5px;
    padding: 10px 20px;
    font-size: 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background-color: #ff7043;
    color: white;
    box-shadow: 0 5px #bf360c;
    transition: background-color 0.2s;
  }
  button:hover {
    background-color: #ff5722;
  }
  button:active {
    box-shadow: 0 2px #bf360c;
    transform: translateY(3px);
  }
  input, select {
    padding: 8px;
    margin: 5px auto;
    width: 80%;
    max-width: 300px;
    border-radius: 8px;
    border: 2px solid #f57c00;
    font-size: 16px;
    display: block;
  }
  #notif {
    margin-top: 15px;
    font-weight: bold;
    color: #004d40;
    min-height: 24px;
  }
  .panel {
    margin-top: 20px;
    background-color: #ffe0b2;
    padding: 15px;
    border-radius: 10px;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
    display: none;
    text-align: left;
  }
  .adminOnly {
    background: #d32f2f !important;
  }
  .confirmed {
    text-decoration: line-through;
    color: gray;
  }
</style>
</head>
<body>

<h1>Game Kotak Hadiah</h1>

<div id="box">üéÅ</div>

<button id="btnOpenBox">Buka Kotak</button>
<button id="btnSupply">Ambil Box Suplai (1x per jam)</button>

<div id="notif"></div>

<hr>

<h3>Poin: <span id="points">0</span></h3>
<h3>Kunci: <span id="keys">0</span></h3>

<hr>

<select id="amount">
  <option value="200">50.000 IC - 200 poin</option>
  <option value="400">100.000 IC - 400 poin</option>
  <option value="1000">250.000 IC - 1000 poin</option>
  <option value="2000">500.000 IC - 2000 poin</option>
  <option value="4000">1.000.000 IC - 4000 poin</option>
  <option value="8000">2.000.000 IC - 8000 poin</option>
</select>

<input type="text" id="nama" placeholder="Nama Lengkap" />
<input type="text" id="rekening" placeholder="Nomor Rekening" />

<button id="btnAjukanPenarikan">Ajukan Penarikan</button>

<hr>

<button id="btnLihatPesan">Lihat Pesan</button>
<button id="btnRiwayatPenarikan">Riwayat Penarikan</button>
<button id="btnKonfirmasiPenarikan" style="display:none;">Konfirmasi Penarikan (Admin)</button>

<div id="pesanPanel" class="panel">
  <h3>Pesan</h3>
  <ul id="messageList"></ul>
  <button id="btnHapusPesan">Hapus Semua Pesan</button>
</div>

<div id="riwayatPanel" class="panel">
  <h3>Riwayat Penarikan</h3>
  <ul id="riwayatList"></ul>
</div>

<div id="konfirmasiPanel" class="panel">
  <h3>Konfirmasi Penarikan</h3>
  <ul id="konfirmasiList"></ul>
</div>

<script>
  // --- SOUNDS ---
  const soundClick = new Audio('https://actions.google.com/sounds/v1/ui/click.ogg');

  function playClick() {
    soundClick.currentTime = 0;
    soundClick.play().catch(() => {}); // ignore errors on autoplay
  }

  // --- ADMIN CHECK (contoh) ---
  // Ganti "adminUser" sesuai username admin atau pakai login sistemmu sendiri
  const adminUser = "admin"; 
  // Simple prompt username
  let currentUser = prompt("Masukkan username (admin untuk akses admin):", "guest");
  if (!currentUser) currentUser = "guest";
  const isAdmin = currentUser.toLowerCase() === adminUser;

  // --- DATA ---
  let points = 0;
  let keys = 0;
  let messages = ["Selamat datang di game!"];
  let riwayatPenarikan = [];
  let penarikanPending = [];

  // DOM Elements
  const notif = document.getElementById('notif');
  const pointsEl = document.getElementById('points');
  const keysEl = document.getElementById('keys');
  const messageList = document.getElementById('messageList');
  const riwayatList = document.getElementById('riwayatList');
  const konfirmasiList = document.getElementById('konfirmasiList');
  const pesanPanel = document.getElementById('pesanPanel');
  const riwayatPanel = document.getElementById('riwayatPanel');
  const konfirmasiPanel = document.getElementById('konfirmasiPanel');
  const btnKonfirmasi = document.getElementById('btnKonfirmasiPenarikan');

  // WebSocket connection
  const wsUrl = "ws://localhost:8080"; // Ganti sesuai alamat servermu
  let ws;

  function initWebSocket() {
    ws = new WebSocket(wsUrl);
    ws.onopen = () => {
      console.log("WebSocket connected");
      // Kirim info user ke server
      ws.send(JSON.stringify({type:"join", user: currentUser, admin: isAdmin}));
    };
    ws.onmessage = (evt) => {
      const data = JSON.parse(evt.data);
      if(data.type === "updatePenarikan"){
        penarikanPending = data.pending;
        riwayatPenarikan = data.history;
        updateKonfirmasiList();
        updateRiwayatList();
      }
      if(data.type === "notif"){
        notif.textContent = data.message;
      }
    };
    ws.onclose = () => {
      console.log("WebSocket disconnected, mencoba reconnect dalam 3 detik...");
      setTimeout(initWebSocket, 3000);
    };
  }

  initWebSocket();

  // Update tampilan poin & kunci
  function updateStats() {
    pointsEl.textContent = points;
    keysEl.textContent = keys;
  }

  // Tampilkan pesan
  function tampilkanPesan() {
    messageList.innerHTML = '';
    messages.forEach((msg) => {
      const li = document.createElement('li');
      li.textContent = msg;
      messageList.appendChild(li);
    });
  }

  // Tampilkan riwayat penarikan
  function updateRiwayatList() {
    riwayatList.innerHTML = '';
    if (riwayatPenarikan.length === 0) {
      riwayatList.innerHTML = '<li>Tidak ada riwayat penarikan.</li>';
      return;
    }
    riwayatPenarikan.forEach((item, idx) => {
      const li = document.createElement('li');
      li.textContent = `${item.nama} - ${item.amount} poin - ${item.tanggal}`;
      riwayatList.appendChild(li);
    });
  }

  // Update daftar penarikan yang belum dikonfirmasi (admin)
  function updateKonfirmasiList() {
    konfirmasiList.innerHTML = '';
    if(penarikanPending.length === 0){
      konfirmasiList.innerHTML = '<li>Tidak ada penarikan yang perlu dikonfirmasi.</li>';
      return;
    }
    penarikanPending.forEach((item, idx) => {
      const li = document.createElement('li');
      li.innerHTML = `
        <strong>${item.nama}</strong> - ${item.amount} poin - ${item.tanggal}
        <button data-idx="${idx}">Konfirmasi</button>
      `;
      konfirmasiList.appendChild(li);
    });
    // Pasang event listener ke tombol konfirmasi
    konfirmasiList.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', () => {
        playClick();
        const index = Number(btn.getAttribute('data-idx'));
        konfirmasiPenarikan(index);
      });
    });
  }

  // Fungsi konfirmasi penarikan (admin only)
  function konfirmasiPenarikan(idx){
    if(!isAdmin) {
      notif.textContent = "Hanya admin yang dapat mengonfirmasi penarikan!";
      return;
    }
    const item = penarikanPending[idx];
    if(!item) return;

    // Kirim ke server konfirmasi penarikan
    ws.send(JSON.stringify({type:"confirm", idx}));
