<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>UANGDUTY</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f0f0f0; }
    .box { background: #fff; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 0 8px #ccc; }
    input, button, textarea { width: 100%; padding: 10px; margin-top: 5px; }
    .chat-box { max-height: 200px; overflow-y: auto; background: #eee; padding: 10px; margin-top: 10px; }
    .message { margin-bottom: 8px; }
    .right { text-align: right; }
    .admin-data { border-top: 1px solid #ccc; margin-top: 10px; padding-top: 10px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>UANGDUTY</h1>

  <div class="box" id="akunBox">
    <h2>Buat Akun Pegawai</h2>
    <input type="text" id="namaDepan" placeholder="Nama Depan">
    <input type="text" id="namaBelakang" placeholder="Nama Belakang">
    <button onclick="buatAkun()">Buat Forum Anda</button>
    <hr>
    <button onclick="masukAdmin()">Mode Admin</button>
  </div>

  <div class="box hidden" id="forumBox">
    <h2>Forum Pegawai</h2>
    <p><strong>Selamat datang:</strong> <span id="namaLengkap"></span></p>
    <p><strong>Saldo:</strong> <span id="saldo">0</span> Rupiah</p>
    <input type="number" id="jumlah" placeholder="Jumlah uang">
    <button onclick="tambahUang()">Tambah</button>
    <button onclick="ambilUang()">Ambil</button>
    <button onclick="setorUang()">Setor (Reset)</button>
    <div id="riwayat"></div>
  </div>

  <div class="box hidden" id="adminBox">
    <h2>Panel Admin</h2>
    <div id="adminList"></div>
  </div>

  <div class="box">
    <h2>Obrolan Chat</h2>
    <div class="chat-box" id="chatBox"></div>
    <textarea id="pesan" placeholder="Ketik pesan..."></textarea>
    <button onclick="kirimPesan()">Kirim</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA3-34rf9VZUIrAIR6z4BJtQm_MClqXm-Q",
      authDomain: "uangduty.firebaseapp.com",
      databaseURL: "https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "uangduty",
      storageBucket: "uangduty.appspot.com",
      messagingSenderId: "598905752132",
      appId: "1:598905752132:web:9b764840e51c13a3044a11"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let userKey = localStorage.getItem("userKey");
    let fullName = localStorage.getItem("fullName");

    if (userKey && fullName && fullName !== "ADMIN") {
      document.getElementById("akunBox").classList.add("hidden");
      document.getElementById("forumBox").classList.remove("hidden");
      document.getElementById("namaLengkap").innerText = fullName;
      pantauSaldo();
      pantauRiwayat();
    }

    function buatAkun() {
      const depan = document.getElementById("namaDepan").value.trim();
      const belakang = document.getElementById("namaBelakang").value.trim();
      const nama = `${depan} ${belakang}`;
      if (!depan || !belakang) return alert("Isi nama lengkap.");

      const ref = db.ref("forum").push();
      ref.set({ nama, saldo: 0 });
      userKey = ref.key;
      fullName = nama;
      localStorage.setItem("userKey", userKey);
      localStorage.setItem("fullName", fullName);
      location.reload();
    }

    function pantauSaldo() {
      db.ref(`forum/${userKey}/saldo`).on("value", snap => {
        const val = snap.val() || 0;
        document.getElementById("saldo").innerText = formatRupiah(val);
      });
    }

    function pantauRiwayat() {
      db.ref(`forum/${userKey}/riwayat`).on("value", snap => {
        const el = document.getElementById("riwayat");
        el.innerHTML = "<h4>Riwayat:</h4>";
        const val = snap.val();
        if (val) {
          const list = Object.values(val).slice(-5);
          for (let log of list) {
            el.innerHTML += `<p>${log}</p>`;
          }
        }
      });
    }

    function tambahUang() {
      ubahSaldo("tambah");
    }

    function ambilUang() {
      ubahSaldo("ambil");
    }

    function setorUang() {
      db.ref(`forum/${userKey}/saldo`).set(0);
      tambahRiwayat("Setor semua saldo ke 0");
    }

    function ubahSaldo(mode) {
      const jumlah = parseInt(document.getElementById("jumlah").value);
      if (isNaN(jumlah) || jumlah <= 0) return alert("Masukkan jumlah valid.");
      const saldoRef = db.ref(`forum/${userKey}/saldo`);
      saldoRef.once("value").then(snap => {
        let saldo = snap.val() || 0;
        saldo = mode === "tambah" ? saldo + jumlah : saldo - jumlah;
        saldoRef.set(saldo);
        tambahRiwayat(`${mode === "tambah" ? "Tambah" : "Ambil"} ${formatRupiah(jumlah)}`);
      });
    }

    function tambahRiwayat(teks) {
      const ref = db.ref(`forum/${userKey}/riwayat`).push();
      ref.set(teks);
    }

    function kirimPesan() {
      const teks = document.getElementById("pesan").value;
      if (!teks.trim()) return;
      const nama = localStorage.getItem("fullName") || "Tamu";
      db.ref("chat").push({ nama, pesan: teks });
      document.getElementById("pesan").value = "";
    }

    db.ref("chat").on("child_added", snap => {
      const { nama, pesan } = snap.val();
      const div = document.createElement("div");
      div.className = "message" + (nama === fullName ? " right" : "");
      div.innerText = `${nama}: ${pesan}`;
      document.getElementById("chatBox").appendChild(div);
      document.getElementById("chatBox").scrollTop = 9999;
    });

    function masukAdmin() {
      const pass = prompt("Masukkan password admin:");
      if (pass === "RFD") {
        fullName = "ADMIN";
        localStorage.setItem("fullName", fullName);
        document.getElementById("akunBox").classList.add("hidden");
        document.getElementById("forumBox").classList.add("hidden");
        document.getElementById("adminBox").classList.remove("hidden");
        tampilkanSemuaData();
      } else {
        alert("Password salah.");
      }
    }

    function tampilkanSemuaData() {
      const list = document.getElementById("adminList");
      list.innerHTML = "";
      db.ref("forum").once("value").then(snap => {
        snap.forEach(child => {
          const data = child.val();
          const id = child.key;
          let el = `<div class="admin-data"><p><strong>Nama:</strong> ${data.nama}</p><p><strong>Saldo:</strong> ${formatRupiah(data.saldo)}</p>`;
          if (data.riwayat) {
            el += `<p><strong>Riwayat:</strong><br>`;
            const logs = Object.values(data.riwayat).slice(-5);
            for (let log of logs) {
              el += `- ${log}<br>`;
            }
            el += `</p>`;
          }
          el += `</div>`;
          list.innerHTML += el;
        });
      });
    }

    function formatRupiah(angka) {
      return angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + "rb";
    }
  </script>
</body>
  </html>
