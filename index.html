<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>UangDuty Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 10px; }
    h1 { color: #333; font-size: 22px; }
    .card {
      background: white; padding: 12px; margin-bottom: 10px; border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative;
    }
    .riwayat { display: none; margin-top: 10px; font-size: 14px; color: #555; }
    .total { font-weight: bold; color: green; }
    .opsi {
      position: absolute; top: 10px; right: 15px; cursor: pointer;
      font-size: 18px; color: #888;
    }
    .popup {
      display: none; position: absolute; right: 15px; top: 30px;
      background: #fff; border: 1px solid #ccc; border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); z-index: 10;
    }
    .popup button {
      display: block; padding: 8px 12px; width: 100%; border: none;
      background: none; text-align: left; font-size: 14px; cursor: pointer;
    }
    .popup button:hover { background-color: #f0f0f0; }
    .running-text {
      background: black; color: white; padding: 8px;
      margin-bottom: 10px; border-radius: 6px;
      font-size: 14px; font-family: monospace;
    }
    .waktu {
      font-size: 13px; color: #999; margin-top: 6px;
    }
    .tag {
      background: gold; color: black; padding: 2px 6px;
      font-size: 12px; border-radius: 4px; margin-left: 5px;
    }
    .refresh-info {
      font-size: 12px; margin: 5px 0 10px; color: #666;
    }
    .btn-riwayat {
      background: #007bff; color: white; padding: 4px 8px;
      border: none; border-radius: 4px; font-size: 13px;
      margin-top: 5px; cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>üìä Uang Duty SAFD</h1>

  <div class="running-text">
    <marquee scrollamount="1" behavior="scroll" direction="left" id="runningRiwayat">
      Memuat riwayat terbaru...
    </marquee>
  </div>

  <div class="refresh-info" id="refresh-info">‚è≥ Memuat ulang dalam 60 detik</div>

  <div id="data-container">Memuat data...</div>

  <script>
    let lastInteraction = Date.now();
    let pauseRefresh = false;
    let refreshInterval = 60000;

    function formatRupiah(angka) {
      return 'Rp. ' + angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function updateCountdown() {
      const remaining = Math.max(0, refreshInterval - (Date.now() - lastInteraction));
      const seconds = Math.ceil(remaining / 1000);
      document.getElementById("refresh-info").innerText = "‚è≥ Memuat ulang dalam " + seconds + " detik";
    }

    function loadData() {
      fetch("https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data.json")
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById("data-container");
          const runningText = document.getElementById("runningRiwayat");
          container.innerHTML = "";
          runningText.innerText = "";

          if (!data) return container.innerHTML = "Tidak ada data.";

          let entries = Object.entries(data);
          entries.sort((a,b) => (b[1].uang||0)-(a[1].uang||0));

          const top3 = entries.slice(0,3).map(x=>x[0]);

          let semuaRiwayat = [];

          entries.forEach(([nama, pemain], index) => {
            const div = document.createElement("div");
            div.className = "card";

            const total = formatRupiah(pemain.uang || 0);
            const tag = top3.includes(nama) ? `<span class="tag">Juara ${top3.indexOf(nama)+1}</span>` : "";

            div.innerHTML = `
              <div><strong>üìõ ${pemain.nama || nama}</strong>${tag}</div>
              <div class="total">Total Uang: ${total}</div>
              <div class="waktu">Terakhir diupdate: ${new Date(pemain.updated || Date.now()).toLocaleString()}</div>
              <div class="riwayat">
                <br><u>üìú Riwayat:</u><br>
                ${pemain.riwayat && pemain.riwayat.length > 0 ? pemain.riwayat.map(r => "‚Ä¢ " + r).join("<br>") : "Tidak ada riwayat"}
              </div>
              <button class="btn-riwayat">üëÅÔ∏è Lihat Riwayat</button>
              <div class="opsi">‚ãÆ</div>
              <div class="popup">
                <button onclick="ubahNama('${nama}')">‚úèÔ∏è Ubah Nama</button>
                <button onclick="hapusForum('${nama}')">üóëÔ∏è Hapus Forum</button>
              </div>
            `;

            // kumpulkan semua riwayat
            if (pemain.riwayat) {
              pemain.riwayat.forEach(r => semuaRiwayat.push(`${pemain.nama || nama}: ${r}`));
            }

            const riwayatDiv = div.querySelector(".riwayat");
            const riwayatBtn = div.querySelector(".btn-riwayat");
            const opsiBtn = div.querySelector(".opsi");
            const popup = div.querySelector(".popup");

            opsiBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              pauseRefresh = true;
              popup.style.display = popup.style.display === "block" ? "none" : "block";
            });

            riwayatBtn.addEventListener("click", () => {
              pauseRefresh = true;
              const visible = riwayatDiv.style.display === "block";
              riwayatDiv.style.display = visible ? "none" : "block";
              riwayatBtn.textContent = visible ? "üëÅÔ∏è Lihat Riwayat" : "‚ùå Tutup Riwayat";
              popup.style.display = "none";
            });

            container.appendChild(div);
          });

          runningText.innerText = semuaRiwayat.length > 0 ? semuaRiwayat.join(" ‚ùñ ") : "Tidak ada riwayat.";
        })
        .catch(err => {
          document.getElementById("data-container").innerHTML = "Gagal memuat data.";
          console.error(err);
        });
    }

    function ubahNama(nama) {
      const baru = prompt("Masukkan nama baru:");
      if (!baru) return;
      fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${nama}.json`, {
        method: "PATCH",
        body: JSON.stringify({ nama: baru })
      }).then(() => loadData());
    }

    function hapusForum(nama) {
      if (!confirm("Yakin ingin menghapus forum ini?")) return;
      fetch(`https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app/data/${nama}.json`, {
        method: "DELETE"
      }).then(() => loadData());
    }

    setInterval(() => {
      updateCountdown();
      if (pauseRefresh) return;
      if (Date.now() - lastInteraction > refreshInterval) {
        loadData();
        lastInteraction = Date.now();
      }
    }, 1000);

    window.addEventListener("click", () => {
      lastInteraction = Date.now();
      pauseRefresh = false;
    });

    loadData();
  </script>
</body>
</html>
