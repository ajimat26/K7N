<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DutyMoney - Sistem Uang Duty Pegawai</title>
<style>
  body { font-family: Arial, sans-serif; background: #f0f4f8; padding: 20px; }
  h1, h2 { color: #2c3e50; }
  #loginSection, #dashboardSection, #adminSection { background: white; padding: 20px; border-radius: 8px; max-width: 700px; margin: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
  input[type=text], input[type=number], input[type=password] {
    padding: 10px; width: 100%; margin: 10px 0; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box;
  }
  button {
    background: #2980b9; color: white; border: none; border-radius: 5px; padding: 10px 15px; cursor: pointer; font-weight: bold;
  }
  button:hover {
    background: #1c5980;
  }
  #saldo { font-size: 1.3em; font-weight: bold; color: #27ae60; margin: 15px 0; }
  #riwayat { background: #ecf0f1; padding: 10px; height: 130px; overflow-y: auto; border-radius: 5px; font-size: 0.9em; margin-top: 10px; }
  #chatBox { background: #fff; height: 200px; overflow-y: auto; border: 1px solid #ccc; border-radius: 5px; padding: 10px; margin-top: 10px; font-size: 0.9em; }
  #chatBox p { margin: 6px 0; padding: 6px 10px; background: #d0e7ff; border-radius: 12px; max-width: 80%; }
  #chatInput { width: 100%; padding: 10px; margin-top: 10px; box-sizing: border-box; border-radius: 5px; border: 1px solid #ccc; }
  #adminSection { display: none; }
  #pegawaiList { max-height: 250px; overflow-y: auto; margin-top: 15px; background: #fafafa; border-radius: 5px; padding: 10px; font-size: 0.9em; }
  #pegawaiList div { border-bottom: 1px solid #ddd; padding: 8px 0; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

<h1>DutyMoney</h1>

<div id="loginSection">
  <h2>Login Pegawai</h2>
  <input type="text" id="inputNama" placeholder="Masukkan nama lengkap" />
  <button onclick="loginPegawai()">Login / Buat Akun</button>
  <hr />
  <button onclick="toggleAdminLogin()">Login sebagai Admin</button>
</div>

<div id="dashboardSection" style="display:none;">
  <h2>Dashboard Pegawai</h2>
  <div>Selamat datang, <span id="namaPegawai"></span></div>
  <div id="saldo">Saldo Duty: 0 Rupiah</div>

  <input type="number" id="inputTambah" placeholder="Jumlah tambah (contoh: 50000)" />
  <button onclick="tambahSaldo()">Tambah Saldo</button>

  <input type="number" id="inputAmbil" placeholder="Jumlah ambil (contoh: 20000)" />
  <button onclick="ambilSaldo()">Ambil Saldo</button>

  <div id="riwayat"><strong>Riwayat Transaksi:</strong><br>Belum ada transaksi.</div>

  <h3>Obrolan Pegawai</h3>
  <div id="chatBox"></div>
  <input type="text" id="chatInput" placeholder="Ketik pesan dan tekan Enter..." onkeydown="if(event.key==='Enter') kirimPesan();" />
  <br />
  <button onclick="logoutPegawai()">Logout</button>
</div>

<div id="adminLoginSection" style="display:none; max-width: 400px; margin:auto; background:white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
  <h2>Login Admin</h2>
  <input type="password" id="inputPasswordAdmin" placeholder="Masukkan password admin" />
  <button onclick="loginAdmin()">Login</button>
  <button onclick="toggleAdminLogin()">Batal</button>
  <div id="adminLoginError" style="color:red; margin-top:10px;"></div>
</div>

<div id="adminSection">
  <h2>Panel Admin</h2>
  <button onclick="logoutAdmin()">Logout Admin</button>

  <h3>Daftar Pegawai</h3>
  <div id="pegawaiList">Loading...</div>

  <h3>Obrolan Semua Pegawai</h3>
  <div id="chatBoxAdmin" style="height:250px; overflow-y:auto; background:#fff; border:1px solid #ccc; border-radius:5px; padding:10px; font-size:0.9em;"></div>
  <input type="text" id="chatInputAdmin" placeholder="Ketik pesan admin dan Enter..." onkeydown="if(event.key==='Enter') kirimPesanAdmin();" />
</div>

<script>
  // --- KONFIGURASI FIREBASE ---
  const firebaseConfig = {
    apiKey: "API_KEY",
    authDomain: "PROJECT_ID.firebaseapp.com",
    databaseURL: "https://PROJECT_ID.firebaseio.com",
    projectId: "PROJECT_ID",
    storageBucket: "PROJECT_ID.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Simpan pegawai login di localStorage
  let pegawaiKey = localStorage.getItem("pegawaiKey");
  let pegawaiNama = localStorage.getItem("pegawaiNama");
  let isAdmin = false;

  // Format angka jadi Rp
  function formatRupiah(angka) {
    if (!angka) return "0 Rupiah";
    return angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + " Rupiah";
  }

  // LOGIN PEGAWAI
  function loginPegawai() {
    const nama = document.getElementById("inputNama").value.trim();
    if(!nama) {
      alert("Masukkan nama lengkap terlebih dahulu.");
      return;
    }

    // Cek apakah nama sudah ada di database pegawai
    db.ref("pegawai").orderByChild("nama").equalTo(nama).once("value").then(snap => {
      if(snap.exists()) {
        // sudah ada, pakai key pertama
        const key = Object.keys(snap.val())[0];
        pegawaiKey = key;
        pegawaiNama = nama;
        localStorage.setItem("pegawaiKey", pegawaiKey);
        localStorage.setItem("pegawaiNama", pegawaiNama);
        masukDashboardPegawai();
      } else {
        // belum ada, buat baru
        const newRef = db.ref("pegawai").push();
        newRef.set({ nama: nama, saldo: 0, riwayat: [] }).then(() => {
          pegawaiKey = newRef.key;
          pegawaiNama = nama;
          localStorage.setItem("pegawaiKey", pegawaiKey);
          localStorage.setItem("pegawaiNama", pegawaiNama);
          masukDashboardPegawai();
        });
      }
    });
  }

  // MASUK DASHBOARD PEGAWAI
  function masukDashboardPegawai() {
    isAdmin = false;
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("dashboardSection").style.display = "block";
    document.getElementById("adminLoginSection").style.display = "none";
    document.getElementById("adminSection").style.display = "none";

    document.getElementById("namaPegawai").innerText = pegawaiNama;

    pantauSaldo();
    pantauRiwayat();
    pantauChat();
  }

  // Logout pegawai
  function logoutPegawai() {
    localStorage.removeItem("pegawaiKey");
    localStorage.removeItem("pegawaiNama");
    pegawaiKey = null;
    pegawaiNama = null;
    location.reload();
  }

  //
