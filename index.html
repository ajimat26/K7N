<!DOCTYPE html>
<html>
<head>
  <title>UANGDUTY SAFD</title>
  <style>
    body {
      background: white;
      font-family: sans-serif;
      padding: 20px;
    }
    .hidden { display: none; }
    input, button { margin: 5px; padding: 8px; }
    .admin-tag { color: red; font-weight: bold; }
    .chat-box { border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: auto; background: #f9f9f9; }
  </style>
</head>
<body>

<h2>Login UANGDUTY SAFD</h2>
<div id="login">
  <input id="name" placeholder="Nama Lengkap"><br>
  <input id="badge" placeholder="Badge (cth: #123)"><br>
  <button id="loginBtn">Login</button>
</div>

<div id="main" class="hidden">
  <h3>Selamat datang, <span id="userDisplay"></span> <span id="adminTag" class="admin-tag"></span></h3>

  <h4>Uang kamu: Rp <span id="money">0</span></h4>
  <input id="amount" placeholder="Jumlah uang"><br>
  <button id="tambahBtn">Tambah Uang</button>
  <button id="ambilBtn">Ambil Uang</button>
  <button id="resetBtn">Setor / Reset Uang</button>

  <hr>
  <h4>Chat:</h4>
  <div class="chat-box" id="chatBox"></div>
  <input id="chatInput" placeholder="Ketik pesan"><button id="kirimBtn">Kirim</button>

  <hr>
  <button id="adminToggleBtn">Akses Admin</button>
  <div id="adminPanel" class="hidden">
    <input id="adminPass" type="password" placeholder="Password Admin">
    <button id="adminMasukBtn">Masuk Admin</button>
  </div>
</div>

<!-- Firebase & Script di bawah body agar tombol dikenali -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyA3-34rf9VZUIrAIR6z4BJtQm_MClqXm-Q",
    authDomain: "uangduty.firebaseapp.com",
    databaseURL: "https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "uangduty",
    storageBucket: "uangduty.appspot.com",
    messagingSenderId: "598905752132",
    appId: "1:598905752132:web:9b764840e51c13a3044a11"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let userKey = "";
  let userFull = "";
  let isAdmin = false;

  document.getElementById("loginBtn").onclick = function() {
    const name = document.getElementById("name").value.trim();
    const badge = document.getElementById("badge").value.trim();
    if (!name || !badge) return alert("Isi semua kolom!");

    userKey = badge + "_" + name.replace(/\s/g, "_");
    userFull = badge + " " + name;

    db.ref("users/" + userKey).once("value", snap => {
      if (!snap.exists()) {
        db.ref("users/" + userKey).set({ uang: 0 });
      }
      document.getElementById("login").classList.add("hidden");
      document.getElementById("main").classList.remove("hidden");
      document.getElementById("userDisplay").innerText = userFull;
      listenMoney();
      listenChat();
    });
  };

  function listenMoney() {
    db.ref("users/" + userKey + "/uang").on("value", snap => {
      document.getElementById("money").innerText = snap.val() || 0;
    });
  }

  document.getElementById("tambahBtn").onclick = function() {
    const val = parseInt(document.getElementById("amount").value);
    if (isNaN(val)) return;
    db.ref("users/" + userKey + "/uang").once("value", snap => {
      let total = (snap.val() || 0) + val;
      db.ref("users/" + userKey + "/uang").set(total);
    });
  };

  document.getElementById("ambilBtn").onclick = function() {
    const val = parseInt(document.getElementById("amount").value);
    if (isNaN(val)) return;
    db.ref("users/" + userKey + "/uang").once("value", snap => {
      let total = (snap.val() || 0) - val;
      db.ref("users/" + userKey + "/uang").set(total);
    });
  };

  document.getElementById("resetBtn").onclick = function() {
    db.ref("users/" + userKey + "/uang").set(0);
  };

  function listenChat() {
    db.ref("chat").limitToLast(20).on("child_added", snap => {
      const box = document.getElementById("chatBox");
      const data = snap.val();
      const tag = data.admin ? "<span class='admin-tag'>(ADMIN)</span> " : "";
      box.innerHTML += `<div>${tag}<b>${data.nama}</b>: ${data.pesan}</div>`;
      box.scrollTop = box.scrollHeight;
    });
  }

  document.getElementById("kirimBtn").onclick = function() {
    const pesan = document.getElementById("chatInput").value;
    if (!pesan) return;
    db.ref("chat").push({
      nama: userFull,
      pesan,
      admin: isAdmin
    });
    document.getElementById("chatInput").value = "";
  };

  document.getElementById("adminToggleBtn").onclick = function() {
    document.getElementById("adminPanel").classList.toggle("hidden");
  };

  document.getElementById("adminMasukBtn").onclick = function() {
    const pw = document.getElementById("adminPass").value;
    if (pw === "RFD1") {
      isAdmin = true;
      document.getElementById("adminTag").innerText = "(ADMIN)";
      alert("Mode Admin aktif!");
    } else {
      alert("Password salah.");
    }
  };
</script>

</body>
</html>
