<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Forum Investasi dengan Uang & Obrolan</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  #saldo { color: green; font-weight: bold; }
  #staffSection { margin-top: 20px; border: 1px solid #ccc; padding: 15px; max-width: 700px; }
  #listForum div { border: 1px solid #ddd; padding: 10px; margin-bottom: 8px; }
  button { cursor: pointer; margin: 5px 0; padding: 8px 15px; }
  input[type="text"], input[type="password"], input[type="number"] { padding: 5px; margin: 5px 0; width: 100%; box-sizing: border-box; }
  #riwayat p { margin: 3px 0; }
  #infoPengguna { font-weight: bold; margin-bottom: 15px; }
  #chatBox {
    border: 1px solid #ccc;
    height: 200px;
    overflow-y: auto;
    padding: 10px;
    margin-bottom: 10px;
    background: #f9f9f9;
  }
  #chatBox p {
    margin: 5px 0;
    padding: 5px 8px;
    background: #e2e2e2;
    border-radius: 5px;
  }
  #chatInput {
    width: 100%;
    padding: 8px;
    box-sizing: border-box;
  }
</style>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

<h1>Forum Investasi dengan Uang & Obrolan</h1>

<div id="infoPengguna"></div>

<div id="akunSection" style="display:none;">
  <h3>Buat Akun Baru</h3>
  <input type="text" id="namaDepan" placeholder="Nama Depan" />
  <input type="text" id="namaBelakang" placeholder="Nama Belakang" />
  <button onclick="buatAkun()">Buat Akun</button>
</div>

<div id="forumSection" style="display:none;">
  <h2>Dashboard Forum</h2>
  <p>Saldo Anda: <span id="saldo">0</span></p>

  <div>
    <input type="number" id="inputTambah" placeholder="Jumlah tambah (contoh: 50000)" />
    <button onclick="tambahUang()">Tambah Uang</button>
  </div>
  <div>
    <input type="number" id="inputAmbil" placeholder="Jumlah ambil (contoh: 25000)" />
    <button onclick="ambilUang()">Ambil Uang</button>
  </div>
  <div>
    <button onclick="setorUang()">Setor Uang (Reset saldo ke 0)</button>
  </div>

  <div id="riwayat">
    <h4>Riwayat Transaksi:</h4>
    <p>Belum ada riwayat transaksi.</p>
  </div>

  <div id="chatSection">
    <h4>Obrolan Forum</h4>
    <div id="chatBox"></div>
    <input type="text" id="chatInput" placeholder="Ketik pesan dan tekan Enter..." onkeydown="if(event.key==='Enter'){kirimPesan();}" />
  </div>
</div>

<button id="btnStaffMode" onclick="masukStaffMode()">Mode Staff</button>

<div id="staffSection" style="display:none;">
  <h2>Panel Staff</h2>
  <input type="password" id="passwordStaff" placeholder="Masukkan password staff" />
  <button onclick="cekPasswordStaff()">Masuk</button>
  <div id="listForum"></div>
</div>

<script>
  // --- FIREBASE CONFIG ---
  const firebaseConfig = {
    apiKey: "API_KEY",
    authDomain: "PROJECT_ID.firebaseapp.com",
    databaseURL: "https://PROJECT_ID.firebaseio.com",
    projectId: "PROJECT_ID",
    storageBucket: "PROJECT_ID.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let userKey = localStorage.getItem("userKey");
  let fullName = localStorage.getItem("fullName");
  let staffLogin = false;

  function formatRupiah(angka) {
    return angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + " Rupiah";
  }

  // Mengecek dan menampilkan UI sesuai status akun
  function cekStatusAkun() {
    if(userKey && fullName) {
      document.getElementById("infoPengguna").innerText = `Selamat datang, ${fullName}`;
      document.getElementById("akunSection").style.display = "none";
      document.getElementById("forumSection").style.display = "block";
      pantauSaldo();
      pantauRiwayat();
      pantauChat();
    } else {
      document.getElementById("infoPengguna").innerText = "Anda belum memiliki akun, silakan buat akun.";
      document.getElementById("akunSection").style.display = "block";
      document.getElementById("forumSection").style.display = "none";
    }
  }

  function buatAkun() {
    const depan = document.getElementById("namaDepan").value.trim();
    const belakang = document.getElementById("namaBelakang").value.trim();

    if (!depan || !belakang) {
      alert("Lengkapi nama depan dan belakang.");
      return;
    }

    if (userKey) {
      alert("Anda sudah memiliki akun, tidak bisa membuat akun baru.");
      return;
    }

    const namaLengkap = `${depan} ${belakang}`;

    const ref = db.ref("forum").push();
    ref.set({
      nama: namaLengkap,
      saldo: 0
    }).then(() => {
      userKey = ref.key;
      fullName = namaLengkap;
      localStorage.setItem("userKey", userKey);
      localStorage.setItem("fullName", fullName);
      alert("Akun berhasil dibuat. Selamat datang, " + fullName);
      cekStatusAkun();
    });
  }

  function pantauSaldo() {
    db.ref(`forum/${userKey}/saldo`).on("value", snap => {
      let val = snap.val() || 0;
      document.getElementById("saldo").innerText = formatRupiah(val);
    });
  }

  function tambahRiwayat(teks) {
    const riwayatRef = db.ref(`forum/${userKey}/riwayat`);
    riwayatRef.once("value").then(snap => {
      let data = snap.val() || {};
      let keys = Object.keys(data);
      if (keys.length >= 5) {
        // Hapus entri paling lama (pertama)
        const keyToRemove = keys[0];
        riwayatRef.child(keyToRemove).remove().then(() => {
          riwayatRef.push(teks);
        });
      } else {
        riwayatRef.push(teks);
      }
    });
  }

  function pantauRiwayat() {
    db.ref(`forum/${userKey}/riwayat`).on("value", snap => {
      const riw = snap.val();
      const el = document.getElementById("riwayat");
      el.innerHTML = "<h4>Riwayat Transaksi:</h4>";
      if (!riw) {
        el.innerHTML += "<p>Belum ada riwayat transaksi.</p>";
        return;
      }
      for (let key in riw) {
        let kalimat = riw[key];
        // Format angka rupiah di kalimat
        kalimat = kalimat.replace(/\d+/g, match => {
          return formatRupiah(match).replace(" Rupiah","");
        });
        el.innerHTML += `<p>${kalimat}rb</p>`;
      }
    });
  }

  // Fungsi tambah uang
  function tambahUang() {
    let val = parseInt(document.getElementById("inputTambah").value);
    if (isNaN(val) || val <= 0) {
      alert("Masukkan jumlah tambah uang valid (lebih dari 0).");
      return;
    }
    const saldoRef = db.ref(`forum/${userKey}/saldo`);
    saldoRef.transaction(current => {
      if (current === null) current = 0;
      return current + val;
    }).then(() => {
      tambahRiwayat(`Menambah uang sebesar ${val}`);
      document.getElementById("inputTambah").value = "";
    });
  }

  // Fungsi ambil uang
  function ambilUang() {
    let val = parseInt(document.getElementById("inputAmbil").value);
    if (isNaN(val) || val <= 0) {
      alert("Masukkan jumlah ambil uang valid (lebih dari 0).");
      return;
    }
    const saldoRef = db.ref(`forum/${userKey}/saldo`);
    saldoRef.transaction(current => {
      if (current === null) current = 0;
      if (val > current) {
        alert("Saldo tidak cukup.");
        return; // batal transaksi
      }
      return current - val;
    }).then(result => {
      if (result.committed) {
        tambahRiwayat(`Mengambil uang sebesar ${val}`);
        document.getElementById("inputAmbil").value = "";
      }
    });
  }

  // Fungsi setor uang (reset saldo ke 0)
  function setorUang() {
    if (!confirm("Yakin ingin reset saldo ke 0?")) return;
    db.ref(`forum/${userKey}/saldo`).set(0).then(() => {
      tambahRiwayat("Setor uang, saldo direset ke 0");
    });
  }

  // --- Obrolan ---

  function kirimPesan() {
    const input = document.getElementById("chatInput");
    let pesan = input.value.trim();
    if (!pesan) return;
    if (!userKey) {
      alert("Anda harus login/daftar untuk mengirim pesan.");
      return;
    }
    const chatRef = db.ref("chat").push();
    chatRef.set({
      user: fullName,
      pesan: pesan,
      waktu: Date.now()
    });
    input.value = "";
  }

  function pantauChat() {
    const chatBox = document.getElementById("chatBox");
    db.ref("chat").limitToLast(50).on("value", snap => {
      const chats = snap.val() || {};
      chatBox.innerHTML = "";
      Object.values(chats).forEach(c => {
        const waktu = new Date(c.waktu);
        const waktuStr = waktu.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
        const p = document.createElement("p");
        p.innerHTML = `<b>${c.user}</b> [${waktuStr}]: ${c.pesan}`;
        chatBox.appendChild(p);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  }

  // --- Staff Mode ---
  function masukStaffMode() {
    document.getElementById("staffSection").style.display = "block";
  }

  function cekPasswordStaff() {
    const pwd = document.getElementById("passwordStaff").value.trim();
    if(pwd === "RFD") {
      staffLogin = true;
      alert("Login staff berhasil.");
      tampilkanForumStaff();
    } else {
      alert("Password salah.");
      staffLogin = false;
      document.getElementById("listForum").innerHTML = "";
    }
  }

  function tampilkanForumStaff() {
    if(!staffLogin) return;
    const listEl = document.getElementById("listForum");
    listEl.innerHTML = "<h3>Daftar Forum</h3>";
    db.ref("forum").once("value").then(snap => {
      const data = snap.val() || {};
      listEl.innerHTML = "<h3>Daftar Forum</h3>";
      for(let key in data){
        const user = data[key];
        const div = document.createElement("div");
        div.innerHTML = `
          <b>${user.nama}</b><br/>
