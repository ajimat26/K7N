<!DOCTYPE html>
<html>
<head>
  <title>Aplikasi Pegawai</title>
  <style>
    body { font-family: Arial; max-width: 600px; margin: 20px auto; }
    #chat { border: 1px solid #ccc; height: 200px; overflow-y: scroll; padding: 5px; margin-bottom: 10px; }
    #pegawaiList table { width: 100%; border-collapse: collapse; }
    #pegawaiList th, #pegawaiList td { border: 1px solid #ccc; padding: 5px; text-align: left; }
    .hidden { display: none; }
  </style>
</head>
<body>

  <div id="loginDiv">
    <h2>Login Pegawai</h2>
    <input id="username" placeholder="Username"><br><br>
    <input id="password" type="password" placeholder="Password"><br><br>
    <button onclick="login()">Login</button>
    <p id="loginInfo" style="color:red;"></p>
  </div>

  <div id="appDiv" class="hidden">
    <h2>Halo, <span id="displayName"></span> (<span id="displayRole"></span>)</h2>
    <p>Total Uang: Rp <span id="uangDisplay">0</span></p>

    <input type="number" id="tambahUangInput" placeholder="Tambah uang (angka)">
    <button onclick="tambahUang()">Tambah</button>
    <button onclick="logout()">Logout</button>

    <div id="adminPanel" class="hidden">
      <h3>Data Semua Pegawai</h3>
      <div id="pegawaiList"></div>
    </div>

    <h3>Chat Realtime</h3>
    <div id="chat"></div>
    <input type="text" id="chatInput" placeholder="Ketik pesan...">
    <button onclick="kirimChat()">Kirim</button>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // CONFIG FIREBASE - GANTI SESUAI PROJECTMU
    const firebaseConfig = {
      apiKey: "AIzaSyA3-34rf9VZUIrAIR6z4BJtQm_MClqXm-Q",
      authDomain: "uangduty.firebaseapp.com",
      databaseURL: "https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "uangduty",
      storageBucket: "uangduty.firebasestorage.app",
      messagingSenderId: "598905752132",
      appId: "1:598905752132:web:7be400c23de21665044a11",
      measurementId: "G-TJL9K6YDL9"
    };

    // INIT FIREBASE
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = null;

    const loginDiv = document.getElementById('loginDiv');
    const appDiv = document.getElementById('appDiv');
    const displayNameSpan = document.getElementById('displayName');
    const displayRoleSpan = document.getElementById('displayRole');
    const uangDisplay = document.getElementById('uangDisplay');
    const tambahUangInput = document.getElementById('tambahUangInput');
    const loginInfo = document.getElementById('loginInfo');
    const adminPanel = document.getElementById('adminPanel');
    const pegawaiList = document.getElementById('pegawaiList');
    const chatDiv = document.getElementById('chat');
    const chatInput = document.getElementById('chatInput');

    // Fungsi login
    function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      loginInfo.innerText = '';

      if (!username || !password) {
        loginInfo.innerText = 'Username dan password harus diisi';
        return;
      }

      db.ref('users/' + username).get().then(snapshot => {
        if (!snapshot.exists()) {
          loginInfo.innerText = 'User tidak ditemukan';
          return;
        }
        const user = snapshot.val();
        if (user.password !== password) {
          loginInfo.innerText = 'Password salah';
          return;
        }
        // Sukses login
        currentUser = { username, role: user.role || 'pegawai' };
        tampilkanApp(user);
        setupRealtimeUang();
        if (currentUser.role === 'admin') {
          tampilkanAdminPanel();
        }
        setupChatListener();
      });
    }

    // Tampilkan app setelah login
    function tampilkanApp(user) {
      loginDiv.classList.add('hidden');
      appDiv.classList.remove('hidden');
      displayNameSpan.innerText = currentUser.username;
      displayRoleSpan.innerText = currentUser.role;
      uangDisplay.innerText = user.uang || 0;
    }

    // Update realtime uang tampilan
    function setupRealtimeUang() {
      db.ref('users/' + currentUser.username + '/uang').on('value', snap => {
        uangDisplay.innerText = snap.val() || 0;
      });
    }

    // Tambah uang
    function tambahUang() {
      const amount = parseInt(tambahUangInput.value);
      if (isNaN(amount)) {
        alert('Masukkan angka yang valid');
        return;
      }
      const userRef = db.ref('users/' + currentUser.username);
      userRef.transaction(user => {
        if (user) {
          if (!user.uang) user.uang = 0;
          user.uang += amount;
        }
        return user;
      });
      tambahUangInput.value = '';
    }

    // Logout
    function logout() {
      location.reload();
    }

    // Tampilkan data semua pegawai (admin)
    function tampilkanAdminPanel() {
      adminPanel.classList.remove('hidden');
      db.ref('users').on('value', snapshot => {
        const users = snapshot.val();
        let html = '<table><tr><th>Username</th><th>Role</th><th>Uang</th></tr>';
        for (const u in users) {
          html += `<tr><td>${u}</td><td>${users[u].role || 'pegawai'}</td><td>Rp ${users[u].uang || 0}</td></tr>`;
        }
        html += '</table>';
        pegawaiList.innerHTML = html;
      });
    }

    // Setup Chat Listener
    function setupChatListener() {
      db.ref('chat').on('child_added', snapshot => {
        const data = snapshot.val();
        const div = document.createElement('div');
        div.textContent = `${data.username}: ${data.message}`;
        chatDiv.appendChild(div);
        chatDiv.scrollTop = chatDiv.scrollHeight;
      });
    }

    // Kirim chat
    function kirimChat() {
      const message = chatInput.value.trim();
      if (!message) return;
      db.ref('chat').push({
        username: currentUser.username,
        message: message,
        timestamp: Date.now()
      });
      chatInput.value = '';
    }
  </script>
</body>
</html>
