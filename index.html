<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Giveaway Dana Kaget</title>
<style>
  body { font-family: Arial, sans-serif; background:#f0f0f0; margin:0; padding:20px;}
  .container { max-width:600px; margin:auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1);}
  h1 { text-align:center; color:#27ae60;}
  label { display:block; margin-top:10px; font-weight:bold;}
  input[type=text] { width:100%; padding:8px; margin-top:5px; border:1px solid #ccc; border-radius:4px;}
  button { margin-top:15px; padding:10px 15px; background:#27ae60; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:16px;}
  button:disabled { background:#999; cursor:not-allowed;}
  .info { margin-top:20px; font-size:14px; }
  #topTier { margin-top:20px; background:#e1f5e1; padding:10px; border-radius:5px; }
  #adminPanel { display:none; margin-top:20px; padding:10px; background:#f9f9f9; border:1px solid #ddd; border-radius:5px;}
  #adminPanel h2 { color:#c0392b;}
  table { width:100%; border-collapse: collapse; margin-top:10px;}
  th, td { border:1px solid #ddd; padding:8px; text-align:left;}
  th { background:#27ae60; color:#fff;}
  .popup {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center;
    visibility:hidden; opacity:0; transition: opacity 0.3s ease;
  }
  .popup.active {
    visibility: visible; opacity:1;
  }
  .popup-content {
    background:#fff; padding:20px; border-radius:8px; max-width:300px; text-align:center;
  }
</style>
</head>
<body>
<div class="container">
  <h1>Giveaway Dana Kaget 20JT</h1>
  <div id="claimSection">
    <label>Masukkan Nama:</label>
    <input type="text" id="inputName" placeholder="Nama kamu" />
    <label>Masukkan Nomor Rekening IC:</label>
    <input type="text" id="inputRek" placeholder="Nomor Rekening IC" />
    <button id="btnClaim" onclick="claimPrize()">Klaim Hadiah</button>
    <div class="info" id="infoMsg"></div>
  </div>

  <div id="moneyInfo" class="info">
    Total Uang Giveaway: <span id="totalMoney">Loading...</span><br />
    Hadiah Supply: 10x Kunci
  </div>

  <div id="topTier">
    <h3>Top 3 Penarik Terbesar</h3>
    <ol id="topList">
      <li>Loading...</li>
    </ol>
  </div>

  <button onclick="openAdminPassword()">REYZEN Only (Admin Panel)</button>

  <div id="adminPanel">
    <h2>Admin Panel</h2>
    <div>
      <button onclick="resetMoney()">Reset Uang Giveaway</button>
      <button onclick="togglePause()">Pause Klaim: <span id="pauseStatus">Tidak</span></button>
      <br /><br />
      <label>Set Jumlah Uang Giveaway (Rp):</label>
      <input type="number" id="inputSetMoney" />
      <button onclick="setMoney()">Set Uang</button>
      <br /><br />
      <h3>Daftar Pemenang</h3>
      <table>
        <thead><tr><th>Nama</th><th>Rekening IC</th><th>Jumlah</th><th>Status</th><th>Aksi</th></tr></thead>
        <tbody id="winnersTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Popup -->
<div id="popup" class="popup">
  <div class="popup-content">
    <p id="popupMessage"></p>
    <button onclick="closePopup()">Tutup</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
  // Ganti config ini dengan config Firebase kamu
  const firebaseConfig = {
    apiKey: "AIzaSyA3-34rf9VZUIrAIR6z4BJtQm_MClqXm-Q",
    authDomain: "uangduty.firebaseapp.com",
    databaseURL: "https://uangduty-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "uangduty",
    storageBucket: "uangduty.firebasestorage.app",
    messagingSenderId: "598905752132",
    appId: "1:598905752132:web:7be400c23de21665044a11",
    measurementId: "G-TJL9K6YDL9"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const adminPassword = "opicantik";

  // Elements
  const totalMoneyEl = document.getElementById("totalMoney");
  const topListEl = document.getElementById("topList");
  const infoMsgEl = document.getElementById("infoMsg");
  const claimSection = document.getElementById("claimSection");
  const winnersTableBody = document.getElementById("winnersTableBody");
  const pauseStatusEl = document.getElementById("pauseStatus");

  let paused = false;

  // Listen total money realtime
  db.ref("totalMoney").on("value", (snapshot) => {
    const val = snapshot.val();
    totalMoneyEl.textContent = val ? "Rp " + val.toLocaleString("id-ID") : "Loading...";
  });

  // Listen pause status realtime
  db.ref("paused").on("value", (snapshot) => {
    paused = snapshot.val() || false;
    pauseStatusEl.textContent = paused ? "Ya" : "Tidak";
    document.getElementById("btnClaim").disabled = paused;
    if(paused){
      infoMsgEl.textContent = "Klaim sedang dihentikan sementara.";
    } else {
      infoMsgEl.textContent = "";
    }
  });

  // Listen winners realtime
  db.ref("winners").on("value", (snapshot) => {
    const winners = snapshot.val() || {};
    // Update table admin
    winnersTableBody.innerHTML = "";
    let topArr = [];
    for (let key in winners) {
      const w = winners[key];
      // Add to admin table
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${w.name}</td>
        <td>${w.rekening}</td>
        <td>Rp ${w.amount.toLocaleString("id-ID")}</td>
        <td>${w.paid ? "Lunas" : "Belum"}</td>
        <td>${w.paid ? "" : `<button onclick="markPaid('${key}')">Lunas</button>`}</td>
      `;
      winnersTableBody.appendChild(tr);
      // Add to top tier array
      topArr.push({name: w.name, amount: w.amount});
    }
    // Update top tier list (sort desc by amount)
    topArr.sort((a,b) => b.amount - a.amount);
    topListEl.innerHTML = "";
    for(let i=0; i<3; i++){
      if(topArr[i]){
        topListEl.innerHTML += `<li>${topArr[i].name} - Rp ${topArr[i].amount.toLocaleString("id-ID")}</li>`;
      }
    }
  });

  // Claim logic
  async function claimPrize() {
    if (paused) {
      alert("Klaim sedang dihentikan sementara.");
      return;
    }
    const name = document.getElementById("inputName").value.trim();
    const rekening = document.getElementById("inputRek").value.trim();
    if (!name || !rekening) {
      infoMsgEl.textContent = "Nama dan Rekening IC harus diisi!";
      return;
    }
    infoMsgEl.textContent = "";

    const claimAmount = Math.floor(Math.random() * 2000000) + 1000000; // Random 1jt - 3jt

    // Run transaction to safely decrease totalMoney and add winner
    try {
      await db.ref("totalMoney").transaction((currentMoney) => {
        if (currentMoney === null) return 50000000; // default 50jt
        if (currentMoney < claimAmount) return; // abort transaction if not enough money
        return currentMoney - claimAmount;
      }, async (error, committed, snapshot) => {
        if (error) {
          alert("Terjadi kesalahan, coba lagi.");
          return;
        }
        if (!committed) {
          alert("Uang giveaway sudah habis.");
          return;
        }
        if (snapshot.val() !== null) {
          // Add winner data
          const winnerData = {
            name,
            rekening,
            amount: claimAmount,
            timestamp: Date.now(),
            paid: false,
          };
          const newWinnerRef = db.ref("winners").push();
          await newWinnerRef.set(winnerData);

          // Disable claim, show popup
          claimSection.style.display = "none";
          showPopup(`Selamat ${name}! Hadiah Rp ${claimAmount.toLocaleString("id-ID")} akan diproses dalam 24 jam. Jika tidak diproses, berarti Reyzen sedang badmood.`);
        }
      });
    } catch (e) {
      alert("Terjadi kesalahan.");
    }
  }

  // Admin functions
  function openAdminPassword() {
    const input = prompt("Masukkan password admin:");
    if(input === adminPassword) {
      document.getElementById("adminPanel").style.display = "block";
    } else {
      alert("Password salah!");
    }
  }

  function resetMoney() {
    if(confirm("Reset uang giveaway menjadi 50.000.000?")) {
      db.ref("totalMoney").set(50000000);
      db.ref("winners").remove();
      alert("Uang giveaway dan daftar pemenang telah direset.");
      claimSection.style.display = "block";
    }
  }

  function togglePause() {
    db.ref("paused").once("value").then(snap => {
      db.ref("paused").set(!snap.val());
    });
  }

  function setMoney() {
    const val = Number(document.getElementById("inputSetMoney").value);
    if(val > 0) {
      db.ref("totalMoney").set(val);
      alert("Jumlah uang giveaway diset ke Rp " + val.toLocaleString("id-ID"));
      claimSection.style.display = "block";
    } else {
      alert("Masukkan angka yang valid.");
    }
  }

  function markPaid(key) {
    db.ref("winners/"+key+"/paid").set(true);
  }

  // Popup
  const popup = document.getElementById("popup");
  const popupMessage = document.getElementById("popupMessage");
  function showPopup(msg) {
    popupMessage.textContent = msg;
    popup.classList.add("active");
  }
  function closePopup() {
    popup.classList.remove("active");
  }

</script>
</body>
  </html>
